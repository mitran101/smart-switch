<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Bill Calculator | SwitchPilot</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&family=DM+Serif+Display:ital@0;1&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --sp-slate: #1a1625;
            --sp-purple: #8b5cf6;
            --sp-purple-dark: #7c3aed;
            --sp-purple-light: #ede9fe;
            --sp-green: #10b981;
            --sp-green-dark: #059669;
            --sp-red: #ef4444;
            --sp-bg: #f8fafc;
            --sp-card: #ffffff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--sp-bg);
            color: var(--sp-slate);
            line-height: 1.6;
        }

        .top-nav {
            background: var(--sp-slate);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .top-logo {
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            font-weight: 700;
            color: white;
        }

        .top-logo span:first-child { font-size: 1.6rem; }
        .top-logo span:last-child { font-size: 1.35rem; }

        .back-home {
            padding: 10px 20px;
            background: rgba(255,255,255,0.1);
            color: white;
            text-decoration: none;
            border-radius: 30px;
            font-weight: 600;
            font-size: 0.9rem;
            transition: background 0.2s;
        }

        .back-home:hover { background: rgba(255,255,255,0.2); }

        .header {
            background: linear-gradient(135deg, var(--sp-slate) 0%, #0a0612 100%);
            color: white;
            padding: 3rem 2rem;
            text-align: center;
        }

        .header h1 {
            font-family: 'DM Serif Display', Georgia, serif;
            font-size: clamp(1.75rem, 4vw, 2.5rem);
            font-weight: 400;
            margin-bottom: 0.5rem;
        }

        .header p { color: #94a3b8; font-size: 1.1rem; }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        @media (max-width: 1100px) {
            .main-container { grid-template-columns: 1fr; }
        }

        .card {
            background: var(--sp-card);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.06);
        }

        .card h2 {
            font-size: 1.3rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .region-bar {
            background: var(--sp-card);
            padding: 20px 30px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .region-bar label { font-weight: 600; }

        .region-bar select {
            padding: 10px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            background: white;
            min-width: 200px;
            cursor: pointer;
        }

        .region-bar select:focus {
            outline: none;
            border-color: var(--sp-purple);
        }

        .loading-state {
            text-align: center;
            padding: 40px;
            color: #64748b;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top-color: var(--sp-purple);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .supplier-selector select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            font-family: inherit;
            background: white;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .supplier-selector select:focus {
            outline: none;
            border-color: var(--sp-purple);
            box-shadow: 0 0 0 3px var(--sp-purple-light);
        }

        .current-rates {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .rate-box {
            background: var(--sp-bg);
            padding: 14px;
            border-radius: 10px;
            text-align: center;
        }

        .rate-box .label {
            font-size: 0.8rem;
            color: #64748b;
            margin-bottom: 4px;
        }

        .rate-box .value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--sp-purple);
        }

        .rate-box .value span {
            font-size: 0.85rem;
            font-weight: 500;
        }

        .bill-summary {
            background: linear-gradient(135deg, var(--sp-purple) 0%, var(--sp-purple-dark) 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
        }

        .period-tabs {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 15px;
        }

        .period-tab {
            padding: 8px 14px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 20px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background 0.2s;
        }

        .period-tab.active {
            background: white;
            color: var(--sp-purple);
        }

        .bill-amount {
            font-size: 3.5rem;
            font-weight: 800;
            line-height: 1;
            margin-bottom: 5px;
        }

        .bill-amount span { font-size: 1.5rem; }

        .bill-breakdown {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .comparison-banner {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }

        .comparison-item {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
        }

        .comparison-item.current { background: var(--sp-purple-light); }
        .comparison-item.svt { background: #fef2f2; }

        .comparison-item .label {
            font-size: 0.8rem;
            color: #64748b;
            margin-bottom: 5px;
        }

        .comparison-item .amount {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .comparison-item.current .amount { color: var(--sp-purple); }
        .comparison-item.svt .amount { color: var(--sp-red); }

        .comparison-vs { font-weight: 700; color: #94a3b8; }

        .savings-badge {
            background: var(--sp-green);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 700;
            text-align: center;
            font-size: 1.1rem;
        }

        .chart-container {
            position: relative;
            height: 320px;
            margin-bottom: 15px;
        }

        .chart-hint {
            text-align: center;
            font-size: 0.85rem;
            color: #64748b;
        }

        .appliances-grid {
            display: grid;
            gap: 12px;
            max-height: 600px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .appliance {
            background: var(--sp-bg);
            padding: 14px;
            border-radius: 10px;
            border: 1px solid #e8e8ed;
        }

        .appliance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .appliance-name {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .appliance-cost {
            font-weight: 700;
            color: var(--sp-purple);
            font-size: 1rem;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e2e8f0;
            outline: none;
            -webkit-appearance: none;
            margin: 8px 0;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--sp-purple);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(139, 92, 246, 0.4);
        }

        .appliance-usage {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #64748b;
        }

        .fuel-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .fuel-tab {
            flex: 1;
            padding: 12px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .fuel-tab.active {
            border-color: var(--sp-purple);
            background: var(--sp-purple-light);
            color: var(--sp-purple);
        }

        .cta-section {
            background: linear-gradient(135deg, var(--sp-slate) 0%, #0a0612 100%);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            color: white;
            grid-column: 1 / -1;
        }

        .cta-section h3 {
            font-family: 'DM Serif Display', Georgia, serif;
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .cta-section p {
            color: #94a3b8;
            margin-bottom: 20px;
        }

        .cta-btn {
            display: inline-block;
            padding: 14px 35px;
            background: var(--sp-green);
            color: white;
            text-decoration: none;
            border-radius: 30px;
            font-weight: 700;
            transition: transform 0.2s, background 0.2s;
        }

        .cta-btn:hover {
            background: var(--sp-green-dark);
            transform: translateY(-2px);
        }

        .footer {
            text-align: center;
            padding: 30px 20px;
            background: var(--sp-slate);
            color: white;
        }

        .footer-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .footer p { color: #94a3b8; font-size: 0.9rem; }

        .appliances-grid::-webkit-scrollbar { width: 6px; }
        .appliances-grid::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
        .appliances-grid::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
    </style>
</head>
<body>
    <nav class="top-nav">
        <a href="index.html" class="top-logo">
            <span>‚ö°</span>
            <span>SwitchPilot</span>
        </a>
        <a href="index.html" class="back-home">‚Üê Back to Home</a>
    </nav>

    <header class="header">
        <h1>Energy Bill Calculator</h1>
        <p>See exactly how your usage adds up and compare tariffs in real-time</p>
    </header>

    <div class="region-bar">
        <label for="postcodeInput">üìç Your Postcode:</label>
        <input type="text" id="postcodeInput" placeholder="e.g. SW1A 1AA" maxlength="8" style="
            padding: 10px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            background: white;
            width: 150px;
            text-transform: uppercase;
            transition: border-color 0.2s, box-shadow 0.2s;
        " onfocus="this.style.borderColor='#8b5cf6'; this.style.boxShadow='0 0 0 3px #ede9fe';" onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none';">
        <span id="regionHint" style="color: #64748b; font-size: 0.9rem;">Enter postcode to detect region</span>
    </div>

    <div class="main-container">
        <div class="card">
            <h2>üìä Tariff Comparison</h2>
            
            <div id="loadingState" class="loading-state">
                <div class="spinner"></div>
                <p>Loading tariff data...</p>
            </div>

            <div id="tariffContent" style="display: none;">
                <div class="supplier-selector">
                    <select id="supplierSelect" onchange="changeSupplier()">
                        <option value="svt">‚ö†Ô∏è SVT Price Cap</option>
                    </select>
                </div>

                <div class="current-rates">
                    <div class="rate-box">
                        <div class="label">‚ö° Electricity</div>
                        <div class="value" id="elecRateDisplay">24.50<span>p/kWh</span></div>
                    </div>
                    <div class="rate-box">
                        <div class="label">üî• Gas</div>
                        <div class="value" id="gasRateDisplay">6.24<span>p/kWh</span></div>
                    </div>
                    <div class="rate-box">
                        <div class="label">‚ö° Standing</div>
                        <div class="value" id="elecStandingDisplay">53.56<span>p/day</span></div>
                    </div>
                    <div class="rate-box">
                        <div class="label">üî• Standing</div>
                        <div class="value" id="gasStandingDisplay">31.66<span>p/day</span></div>
                    </div>
                </div>

                <div class="bill-summary">
                    <div class="period-tabs">
                        <button class="period-tab" onclick="setPeriod('day')">Daily</button>
                        <button class="period-tab" onclick="setPeriod('week')">Weekly</button>
                        <button class="period-tab active" onclick="setPeriod('month')">Monthly</button>
                        <button class="period-tab" onclick="setPeriod('year')">Annual</button>
                    </div>
                    <div class="bill-amount" id="totalBill">¬£0<span>/mo</span></div>
                    <div class="bill-breakdown" id="billBreakdown">Elec: ¬£0 | Gas: ¬£0 | Standing: ¬£0</div>
                </div>

                <div class="comparison-banner">
                    <div class="comparison-item current">
                        <div class="label">Selected Tariff</div>
                        <div class="amount" id="currentTariffCost">¬£0/yr</div>
                    </div>
                    <div class="comparison-vs">vs</div>
                    <div class="comparison-item svt">
                        <div class="label">SVT Price Cap</div>
                        <div class="amount" id="svtCost">¬£0/yr</div>
                    </div>
                </div>
                <div class="savings-badge" id="savingsBadge">You're saving ¬£0/year</div>

                <h2 style="margin-top: 25px;">üí∞ Best Deals in <span id="regionDisplay">London</span></h2>
                <div class="chart-container">
                    <canvas id="tariffChart"></canvas>
                </div>
                <p class="chart-hint">üëÜ Click a bar to select that supplier</p>
            </div>
        </div>

        <div class="card">
            <h2>üîå Your Usage</h2>
            
            <div class="fuel-tabs">
                <button class="fuel-tab active" id="elecTab" onclick="showFuel('elec')">‚ö° Electricity</button>
                <button class="fuel-tab" id="gasTab" onclick="showFuel('gas')">üî• Gas</button>
            </div>

            <div id="elecAppliances" class="appliances-grid"></div>
            <div id="gasAppliances" class="appliances-grid" style="display: none;"></div>
        </div>

        <div class="cta-section">
            <h3>Stop overpaying for energy</h3>
            <p>SwitchPilot automatically moves you to the best deal ‚Äî set it and forget it.</p>
            <a href="#waitlist" class="cta-btn">Join the Waitlist ‚Üí</a>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-logo">
            <span>‚ö°</span>
            <span>SwitchPilot</span>
        </div>
        <p>Putting the power back in your hands</p>
    </footer>

    <script>
        // SVT Price Cap (Jan 2026)
        const SVT = { elec_unit: 24.50, elec_standing: 53.56, gas_unit: 6.24, gas_standing: 31.66 };

        const supplierColors = {
            'fuse_energy': '#ffb366',
            'edf': '#ff8c00',
            'eon_next': '#e4002b',
            'scottish_power': '#7dd87d',
            'ovo': '#00dc64',
            'british_gas': '#0066cc',
            'octopus': '#a855f7',
            'svt': '#ef4444'
        };

        const supplierNames = {
            'octopus': 'Octopus Energy',
            'fuse_energy': 'Fuse Energy',
            'eon_next': 'E.ON Next',
            'british_gas': 'British Gas',
            'ovo': 'OVO Energy',
            'scottish_power': 'Scottish Power',
            'edf': 'EDF'
        };

        const elecAppliances = [
            { name: 'Fridge/Freezer', power: 0.15, unit: 'hours/day', max: 24, default: 24, id: 'fridge' },
            { name: 'LED Lights', power: 0.06, unit: 'hours/day', max: 24, default: 6, id: 'lights' },
            { name: 'TV', power: 0.1, unit: 'hours/day', max: 24, default: 4, id: 'tv' },
            { name: 'Laptop/Computer', power: 0.075, unit: 'hours/day', max: 24, default: 6, id: 'computer' },
            { name: 'Washing Machine', power: 1.5, unit: 'loads/week', max: 14, default: 4, id: 'washing' },
            { name: 'Dishwasher', power: 1.2, unit: 'loads/week', max: 14, default: 3, id: 'dishwasher' },
            { name: 'Kettle', power: 0.15, unit: 'boils/day', max: 20, default: 4, id: 'kettle' },
            { name: 'Microwave', power: 0.8, unit: 'uses/day', max: 10, default: 2, id: 'microwave' },
            { name: 'Electric Shower', power: 1.5, unit: 'mins/day', max: 60, default: 0, id: 'eshower' },
            { name: 'Electric Heating', power: 2.0, unit: 'hours/day', max: 24, default: 0, id: 'eheating' },
            { name: 'EV Charger', power: 7.0, unit: 'hours/week', max: 50, default: 0, id: 'evcharger' }
        ];

        const gasAppliances = [
            { name: 'Gas Hob', power: 2.0, unit: 'hours/day', max: 4, default: 0.5, id: 'hob' },
            { name: 'Gas Oven', power: 2.5, unit: 'hours/day', max: 4, default: 0.5, id: 'oven' },
            { name: 'Gas Shower (Combi)', power: 10.0, unit: 'mins/day', max: 60, default: 15, id: 'gshower' },
            { name: 'Central Heating (Winter)', power: 15.0, unit: 'hours/day', max: 24, default: 4, id: 'heating' },
            { name: 'Hot Water (Non-Combi)', power: 3.0, unit: 'hours/day', max: 8, default: 0, id: 'hotwater' }
        ];

        // Postcode to region mapping
        const postcodeRegions = {
            'AB': 'North Scotland', 'IV': 'North Scotland', 'KW': 'North Scotland', 'PH': 'North Scotland', 'DD': 'North Scotland', 'FK': 'North Scotland',
            'G': 'South Scotland', 'PA': 'South Scotland', 'KA': 'South Scotland', 'ML': 'South Scotland', 'EH': 'South Scotland', 'KY': 'South Scotland', 'TD': 'South Scotland', 'DG': 'South Scotland',
            'NE': 'North East', 'DH': 'North East', 'SR': 'North East', 'TS': 'North East', 'DL': 'North East',
            'YO': 'Yorkshire', 'HU': 'Yorkshire', 'DN': 'Yorkshire', 'S': 'Yorkshire', 'HD': 'Yorkshire', 'HX': 'Yorkshire', 'WF': 'Yorkshire', 'LS': 'Yorkshire', 'BD': 'Yorkshire', 'HG': 'Yorkshire',
            'M': 'North West', 'OL': 'North West', 'BL': 'North West', 'SK': 'North West', 'WN': 'North West', 'PR': 'North West', 'BB': 'North West', 'FY': 'North West', 'LA': 'North West', 'CA': 'North West', 'CW': 'North West',
            'L': 'North Wales & Merseyside', 'CH': 'North Wales & Merseyside', 'LL': 'North Wales & Merseyside', 'WA': 'North Wales & Merseyside',
            'CF': 'South Wales', 'NP': 'South Wales', 'SA': 'South Wales',
            'B': 'West Midlands', 'CV': 'West Midlands', 'DY': 'West Midlands', 'WS': 'West Midlands', 'WV': 'West Midlands', 'ST': 'West Midlands', 'TF': 'West Midlands', 'SY': 'West Midlands', 'WR': 'West Midlands', 'HR': 'West Midlands',
            'DE': 'East Midlands', 'NG': 'East Midlands', 'LE': 'East Midlands', 'LN': 'East Midlands', 'PE': 'East Midlands', 'NN': 'East Midlands',
            'IP': 'Eastern', 'NR': 'Eastern', 'CB': 'Eastern', 'CO': 'Eastern', 'CM': 'Eastern', 'SG': 'Eastern', 'AL': 'Eastern', 'EN': 'Eastern', 'SS': 'Eastern', 'RM': 'Eastern',
            'E': 'London', 'EC': 'London', 'N': 'London', 'NW': 'London', 'SE': 'London', 'SW': 'London', 'W': 'London', 'WC': 'London',
            'BN': 'South East', 'RH': 'South East', 'TN': 'South East', 'CT': 'South East', 'ME': 'South East', 'DA': 'South East', 'BR': 'South East', 'CR': 'South East', 'KT': 'South East', 'SM': 'South East', 'SL': 'South East', 'HP': 'South East', 'MK': 'South East', 'LU': 'South East', 'OX': 'South East', 'RG': 'South East', 'GU': 'South East',
            'BH': 'Southern', 'SO': 'Southern', 'PO': 'Southern', 'SP': 'Southern',
            'PL': 'South West', 'TR': 'South West', 'EX': 'South West', 'TQ': 'South West', 'DT': 'South West', 'BA': 'South West', 'TA': 'South West', 'BS': 'South West', 'GL': 'South West', 'SN': 'South West'
        };

        function detectRegion(postcode) {
            const cleaned = postcode.replace(/\s/g, '').toUpperCase();
            for (let len = 3; len >= 1; len--) {
                const prefix = cleaned.substring(0, len);
                if (postcodeRegions[prefix]) return postcodeRegions[prefix];
            }
            return null;
        }

        let allTariffs = [];
        let regionalTariffs = [];
        let currentRegion = 'London';
        let currentTariff = null;
        let currentPeriod = 'month';
        let periodMultiplier = 30;
        let tariffChart = null;

        document.addEventListener('DOMContentLoaded', () => {
            createAppliances();
            loadTariffData();
            
            // Postcode input listener
            document.getElementById('postcodeInput').addEventListener('input', function() {
                const postcode = this.value;
                const hint = document.getElementById('regionHint');
                const region = detectRegion(postcode);
                
                if (region) {
                    currentRegion = region;
                    hint.textContent = '‚úì ' + region;
                    hint.style.color = '#10b981';
                    
                    // Re-filter tariffs for new region
                    if (allTariffs.length > 0) {
                        changeRegion();
                    }
                } else if (postcode.length >= 2) {
                    hint.textContent = '‚ö† Region not found';
                    hint.style.color = '#ef4444';
                } else {
                    hint.textContent = 'Enter postcode to detect region';
                    hint.style.color = '#64748b';
                }
            });
        });

        async function loadTariffData() {
            try {
                const response = await fetch('./all_tariffs.json');
                const data = await response.json();
                
                allTariffs = (data.tariffs || data).filter(t => 
                    !t.error && 
                    t.elec_unit_rate_p && 
                    t.gas_unit_rate_p &&
                    supplierNames[t.supplier]
                );

                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('tariffContent').style.display = 'block';
                
                // Set default region and load
                currentRegion = 'London';
                changeRegion();
            } catch (e) {
                console.error('Failed to load tariff data:', e);
                document.getElementById('loadingState').innerHTML = `
                    <p style="color: var(--sp-red);">Failed to load tariff data. Please refresh.</p>
                `;
            }
        }

        function createAppliances() {
            const elecContainer = document.getElementById('elecAppliances');
            const gasContainer = document.getElementById('gasAppliances');

            elecAppliances.forEach(app => {
                elecContainer.innerHTML += createApplianceHTML(app);
            });

            gasAppliances.forEach(app => {
                gasContainer.innerHTML += createApplianceHTML(app);
            });
        }

        function createApplianceHTML(app) {
            return `
                <div class="appliance">
                    <div class="appliance-header">
                        <span class="appliance-name">${app.name}</span>
                        <span class="appliance-cost" id="${app.id}-cost">¬£0.00</span>
                    </div>
                    <input type="range" id="${app.id}" min="0" max="${app.max}" value="${app.default}" step="0.5" 
                           oninput="updateAppliance('${app.id}')">
                    <div class="appliance-usage">
                        <span><span id="${app.id}-value">${app.default}</span> ${app.unit}</span>
                        <span>${app.power} kWh/${app.unit.split('/')[0]}</span>
                    </div>
                </div>
            `;
        }

        function showFuel(fuel) {
            document.getElementById('elecAppliances').style.display = fuel === 'elec' ? 'grid' : 'none';
            document.getElementById('gasAppliances').style.display = fuel === 'gas' ? 'grid' : 'none';
            document.getElementById('elecTab').classList.toggle('active', fuel === 'elec');
            document.getElementById('gasTab').classList.toggle('active', fuel === 'gas');
        }

        function changeRegion() {
            // Update region display
            document.getElementById('regionDisplay').textContent = currentRegion;
            
            // Get best tariff per supplier for this region
            regionalTariffs = [];
            const seenSuppliers = new Set();
            
            allTariffs
                .filter(t => t.region === currentRegion)
                .sort((a, b) => a.elec_unit_rate_p - b.elec_unit_rate_p)
                .forEach(t => {
                    if (!seenSuppliers.has(t.supplier)) {
                        seenSuppliers.add(t.supplier);
                        regionalTariffs.push(t);
                    }
                });

            populateSuppliers();
            calculateAll();
        }

        function populateSuppliers() {
            const select = document.getElementById('supplierSelect');
            select.innerHTML = '<option value="svt">‚ö†Ô∏è SVT Price Cap</option>';
            
            regionalTariffs.forEach((t, i) => {
                select.innerHTML += `<option value="${i}">${supplierNames[t.supplier]}</option>`;
            });

            // Auto-select cheapest
            if (regionalTariffs.length > 0) {
                select.value = findCheapestIndex();
            }
            
            changeSupplier();
        }

        function changeSupplier() {
            const value = document.getElementById('supplierSelect').value;
            
            if (value === 'svt') {
                currentTariff = {
                    supplier: 'svt',
                    elec_unit_rate_p: SVT.elec_unit,
                    elec_standing_p: SVT.elec_standing,
                    gas_unit_rate_p: SVT.gas_unit,
                    gas_standing_p: SVT.gas_standing
                };
            } else {
                currentTariff = regionalTariffs[parseInt(value)];
            }

            updateRatesDisplay();
            calculateAll();
        }

        function updateRatesDisplay() {
            if (!currentTariff) return;
            
            document.getElementById('elecRateDisplay').innerHTML = 
                `${currentTariff.elec_unit_rate_p.toFixed(2)}<span>p/kWh</span>`;
            document.getElementById('gasRateDisplay').innerHTML = 
                `${currentTariff.gas_unit_rate_p.toFixed(2)}<span>p/kWh</span>`;
            document.getElementById('elecStandingDisplay').innerHTML = 
                `${currentTariff.elec_standing_p.toFixed(1)}<span>p/day</span>`;
            document.getElementById('gasStandingDisplay').innerHTML = 
                `${currentTariff.gas_standing_p.toFixed(1)}<span>p/day</span>`;
        }

        function setPeriod(period) {
            currentPeriod = period;
            periodMultiplier = { day: 1, week: 7, month: 30, year: 365 }[period];

            document.querySelectorAll('.period-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            calculateAll();
        }

        function updateAppliance(id) {
            const value = document.getElementById(id).value;
            document.getElementById(`${id}-value`).textContent = parseFloat(value).toFixed(1);
            calculateAll();
        }

        function calculateDailyKwh(appliances, type) {
            let total = 0;
            const rate = type === 'elec' ? currentTariff.elec_unit_rate_p : currentTariff.gas_unit_rate_p;

            appliances.forEach(app => {
                const value = parseFloat(document.getElementById(app.id).value);
                let dailyKwh = 0;

                if (app.unit.includes('week')) dailyKwh = (value / 7) * app.power;
                else if (app.unit.includes('mins')) dailyKwh = (value / 60) * app.power;
                else dailyKwh = value * app.power;

                const periodCost = (dailyKwh * periodMultiplier * rate) / 100;
                document.getElementById(`${app.id}-cost`).textContent = `¬£${periodCost.toFixed(2)}`;
                
                total += dailyKwh;
            });

            return total;
        }

        function calculateDailyKwhRaw(appliances) {
            let total = 0;
            appliances.forEach(app => {
                const value = parseFloat(document.getElementById(app.id)?.value || app.default);
                if (app.unit.includes('week')) total += (value / 7) * app.power;
                else if (app.unit.includes('mins')) total += (value / 60) * app.power;
                else total += value * app.power;
            });
            return total;
        }

        function calculateAll() {
            if (!currentTariff) return;

            const elecKwhDaily = calculateDailyKwh(elecAppliances, 'elec');
            const gasKwhDaily = calculateDailyKwh(gasAppliances, 'gas');

            const elecUsageCost = (elecKwhDaily * periodMultiplier * currentTariff.elec_unit_rate_p) / 100;
            const gasUsageCost = (gasKwhDaily * periodMultiplier * currentTariff.gas_unit_rate_p) / 100;
            const elecStandingCost = (currentTariff.elec_standing_p * periodMultiplier) / 100;
            const gasStandingCost = (currentTariff.gas_standing_p * periodMultiplier) / 100;

            const totalCost = elecUsageCost + gasUsageCost + elecStandingCost + gasStandingCost;

            const periodSuffix = { day: '/day', week: '/wk', month: '/mo', year: '/yr' }[currentPeriod];
            document.getElementById('totalBill').innerHTML = `¬£${totalCost.toFixed(0)}<span>${periodSuffix}</span>`;
            document.getElementById('billBreakdown').textContent = 
                `Elec: ¬£${elecUsageCost.toFixed(0)} | Gas: ¬£${gasUsageCost.toFixed(0)} | Standing: ¬£${(elecStandingCost + gasStandingCost).toFixed(0)}`;

            // Annual comparison
            const annualCurrent = calcAnnualCost(currentTariff, elecKwhDaily, gasKwhDaily);
            const annualSVT = calcAnnualCost({
                elec_unit_rate_p: SVT.elec_unit,
                gas_unit_rate_p: SVT.gas_unit,
                elec_standing_p: SVT.elec_standing,
                gas_standing_p: SVT.gas_standing
            }, elecKwhDaily, gasKwhDaily);

            document.getElementById('currentTariffCost').textContent = `¬£${Math.round(annualCurrent)}/yr`;
            document.getElementById('svtCost').textContent = `¬£${Math.round(annualSVT)}/yr`;

            const savings = annualSVT - annualCurrent;
            const savingsBadge = document.getElementById('savingsBadge');
            if (savings > 0) {
                savingsBadge.textContent = `‚úì You're saving ¬£${Math.round(savings)}/year vs SVT`;
                savingsBadge.style.background = 'var(--sp-green)';
            } else if (savings < 0) {
                savingsBadge.textContent = `‚ö†Ô∏è ¬£${Math.round(Math.abs(savings))}/year more than SVT`;
                savingsBadge.style.background = 'var(--sp-red)';
            } else {
                savingsBadge.textContent = `Same as SVT`;
                savingsBadge.style.background = '#94a3b8';
            }

            updateChart();
        }

        function calcAnnualCost(tariff, elecKwhDaily, gasKwhDaily) {
            return ((elecKwhDaily * 365 * tariff.elec_unit_rate_p) + 
                   (gasKwhDaily * 365 * tariff.gas_unit_rate_p) +
                   (tariff.elec_standing_p * 365) +
                   (tariff.gas_standing_p * 365)) / 100;
        }

        function findCheapestIndex() {
            const elecKwhDaily = calculateDailyKwhRaw(elecAppliances);
            const gasKwhDaily = calculateDailyKwhRaw(gasAppliances);

            let cheapestIdx = 0;
            let lowestCost = Infinity;

            regionalTariffs.forEach((t, i) => {
                const cost = calcAnnualCost(t, elecKwhDaily, gasKwhDaily);
                if (cost < lowestCost) {
                    lowestCost = cost;
                    cheapestIdx = i;
                }
            });

            return cheapestIdx;
        }

        function updateChart() {
            const elecKwhDaily = calculateDailyKwhRaw(elecAppliances);
            const gasKwhDaily = calculateDailyKwhRaw(gasAppliances);

            const chartData = regionalTariffs.map(t => ({
                supplier: t.supplier,
                name: supplierNames[t.supplier],
                cost: calcAnnualCost(t, elecKwhDaily, gasKwhDaily),
                tariff: t
            }));

            // Add SVT
            chartData.push({
                supplier: 'svt',
                name: 'SVT Price Cap',
                cost: calcAnnualCost({
                    elec_unit_rate_p: SVT.elec_unit,
                    gas_unit_rate_p: SVT.gas_unit,
                    elec_standing_p: SVT.elec_standing,
                    gas_standing_p: SVT.gas_standing
                }, elecKwhDaily, gasKwhDaily),
                tariff: null
            });

            chartData.sort((a, b) => a.cost - b.cost);

            const ctx = document.getElementById('tariffChart').getContext('2d');
            
            if (tariffChart) tariffChart.destroy();

            tariffChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.map(d => d.name),
                    datasets: [{
                        data: chartData.map(d => Math.round(d.cost)),
                        backgroundColor: chartData.map(d => 
                            d.tariff === currentTariff || (d.supplier === 'svt' && currentTariff?.supplier === 'svt')
                                ? supplierColors[d.supplier] 
                                : supplierColors[d.supplier] + '60'
                        ),
                        borderColor: chartData.map(d => 
                            d.tariff === currentTariff || (d.supplier === 'svt' && currentTariff?.supplier === 'svt')
                                ? supplierColors[d.supplier] 
                                : 'transparent'
                        ),
                        borderWidth: 2,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: { label: ctx => `¬£${ctx.raw}/year` }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: { color: '#f1f5f9' },
                            ticks: { callback: v => `¬£${v}` }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { font: { size: 12 } }
                        }
                    },
                    onClick: (e, elements) => {
                        if (elements.length > 0) {
                            const item = chartData[elements[0].index];
                            const select = document.getElementById('supplierSelect');
                            
                            if (item.supplier === 'svt') {
                                select.value = 'svt';
                            } else {
                                const idx = regionalTariffs.indexOf(item.tariff);
                                select.value = idx;
                            }
                            changeSupplier();
                        }
                    }
                }
            });

            tariffChart.chartData = chartData;
        }
    </script>
</body>
</html>
