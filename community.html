<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Community Discussions - SwitchPilot</title>
<style>
html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: #0c0e1f;
  color: #fff;
  overflow-x: hidden;
  background-image:
    linear-gradient(rgba(99,102,241,0.12) 1px, transparent 1px),
    linear-gradient(90deg, rgba(236,72,153,0.12) 1px, transparent 1px);
  background-size: 70px 70px;
  min-height: 100vh;
}

.energy-grid {
  position: fixed;
  inset: 0;
  background-image:
    linear-gradient(rgba(99,102,241,0.12) 1px, transparent 1px),
    linear-gradient(90deg, rgba(236,72,153,0.12) 1px, transparent 1px);
  background-size: 70px 70px;
  opacity: .10;
  animation: energyGridMove 18s linear infinite;
  pointer-events: none;
  z-index: 0;
}
@keyframes energyGridMove {
  0% { transform: translateY(0); }
  100% { transform: translateY(60px); }
}

.top-logo {
  position: absolute;
  top: 25px;
  left: 30px;
  z-index: 9999;
  display: flex;
  align-items: center;
  gap: 10px;
  text-decoration: none;
  color: #fff;
}
.top-logo span:first-child {
  font-size: 2.3rem;
  filter: drop-shadow(0 5px 10px rgba(0,0,0,0.4));
}
.top-logo span:last-child {
  font-size: 1.9rem;
  font-weight: 900;
  letter-spacing: -0.5px;
}

.main-container {
  position: relative;
  z-index: 5;
  padding: 7rem 2rem 4rem;
  max-width: 1200px;
  margin: 0 auto;
}

.page-header {
  text-align: center;
  margin-bottom: 3rem;
}

.page-header h1 {
  font-size: 3.5rem;
  font-weight: 900;
  margin: 0 0 1rem;
  text-shadow: 0 5px 30px rgba(99,102,241,0.5);
}

.page-header p {
  font-size: 1.2rem;
  opacity: 0.85;
  max-width: 600px;
  margin: 0 auto;
  line-height: 1.6;
}

.back-home {
  display: inline-block;
  margin-bottom: 1.5rem;
  padding: 0.6rem 1.4rem;
  background: rgba(255,255,255,0.14);
  border-radius: 999px;
  font-size: 0.95rem;
  font-weight: 600;
  color: #e5e7ff;
  text-decoration: none;
  backdrop-filter: blur(8px);
  transition: .3s;
}
.back-home:hover {
  background: rgba(255,255,255,0.2);
}

.floating-symbols {
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 1;
  overflow: hidden;
}
.symbol {
  position: absolute;
  font-size: 3rem;
  opacity: 0.6;
  animation: drift 10s ease-in-out infinite;
  filter: drop-shadow(0 0 20px rgba(99,102,241,0.6));
}
@keyframes drift {
  0%, 100% { transform: translate(0,0) rotate(0deg); }
  50% { transform: translate(20px,-30px) rotate(10deg); }
}
.symbol:nth-child(1) { left: 5%; top: 20%; animation-delay: 0s; }
.symbol:nth-child(2) { right: 8%; top: 15%; animation-delay: 2s; }
.symbol:nth-child(3) { left: 10%; bottom: 25%; animation-delay: 4s; }
.symbol:nth-child(4) { right: 5%; bottom: 30%; animation-delay: 1s; }

.content-grid {
  display: grid;
  grid-template-columns: 1fr 320px;
  gap: 2rem;
  align-items: start;
}

.discussions-panel {
  background: rgba(17,22,46,0.95);
  border-radius: 22px;
  border: 1px solid rgba(255,255,255,0.08);
  box-shadow: 0 20px 60px rgba(0,0,0,0.4);
  overflow: hidden;
}

.new-post-section {
  padding: 2rem;
  border-bottom: 1px solid rgba(255,255,255,0.08);
  background: rgba(99,102,241,0.05);
}

.new-post-section h3 {
  margin: 0 0 1rem;
  font-size: 1.3rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.form-group {
  margin-bottom: 1rem;
}

.form-group label {
  display: block;
  font-size: 0.9rem;
  font-weight: 600;
  margin-bottom: 0.5rem;
  opacity: 0.9;
}

.form-group input,
.form-group textarea,
.form-group select {
  width: 100%;
  padding: 0.9rem 1rem;
  border-radius: 12px;
  border: 2px solid rgba(255,255,255,0.1);
  background: rgba(255,255,255,0.05);
  color: #fff;
  font-size: 1rem;
  font-family: inherit;
  box-sizing: border-box;
  transition: 0.3s;
}

.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus {
  outline: none;
  border-color: rgba(99,102,241,0.5);
  background: rgba(255,255,255,0.08);
}

.form-group textarea {
  min-height: 100px;
  resize: vertical;
}

.form-group select option {
  background: #1a1a2e;
  color: #fff;
}

.submit-btn {
  padding: 0.9rem 2rem;
  border: none;
  border-radius: 12px;
  font-size: 1rem;
  font-weight: 700;
  background: linear-gradient(135deg, #6366f1, #ec4899);
  color: #fff;
  cursor: pointer;
  box-shadow: 0 8px 25px rgba(236,72,153,0.3);
  transition: 0.3s;
}

.submit-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 35px rgba(236,72,153,0.4);
}

.submit-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.filter-tabs {
  display: flex;
  gap: 0.5rem;
  padding: 1.2rem 2rem;
  border-bottom: 1px solid rgba(255,255,255,0.08);
  overflow-x: auto;
  flex-wrap: wrap;
}

.filter-tab {
  padding: 0.6rem 1.2rem;
  border-radius: 20px;
  border: 1px solid rgba(255,255,255,0.15);
  background: transparent;
  color: #fff;
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  transition: 0.3s;
  white-space: nowrap;
}

.filter-tab:hover {
  background: rgba(255,255,255,0.1);
}

.filter-tab.active {
  background: linear-gradient(135deg, #6366f1, #ec4899);
  border-color: transparent;
}

.sort-bar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0.8rem 2rem;
  border-bottom: 1px solid rgba(255,255,255,0.06);
  background: rgba(0,0,0,0.1);
}

.sort-bar span {
  font-size: 0.9rem;
  opacity: 0.7;
}

.sort-options {
  display: flex;
  gap: 0.5rem;
}

.sort-btn {
  padding: 0.4rem 0.8rem;
  border-radius: 8px;
  border: 1px solid rgba(255,255,255,0.1);
  background: transparent;
  color: #fff;
  font-size: 0.8rem;
  cursor: pointer;
  transition: 0.3s;
}

.sort-btn:hover {
  background: rgba(255,255,255,0.1);
}

.sort-btn.active {
  background: rgba(99,102,241,0.3);
  border-color: rgba(99,102,241,0.5);
}

.discussions-list {
  max-height: 900px;
  overflow-y: auto;
}

.loading-state {
  text-align: center;
  padding: 4rem 2rem;
}

.loading-spinner {
  width: 50px;
  height: 50px;
  border: 4px solid rgba(99,102,241,0.2);
  border-top-color: #6366f1;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 1rem;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.discussion-item {
  padding: 1.5rem 2rem;
  border-bottom: 1px solid rgba(255,255,255,0.06);
  cursor: pointer;
  transition: 0.3s;
}

.discussion-item:hover {
  background: rgba(99,102,241,0.08);
}

.discussion-item.expanded {
  background: rgba(99,102,241,0.1);
}

.discussion-item.pinned {
  background: rgba(251,191,36,0.08);
  border-left: 3px solid #fbbf24;
}

.pinned-badge {
  display: inline-flex;
  align-items: center;
  gap: 0.3rem;
  padding: 0.2rem 0.6rem;
  background: rgba(251,191,36,0.2);
  color: #fde68a;
  border-radius: 6px;
  font-size: 0.75rem;
  font-weight: 600;
  margin-bottom: 0.5rem;
}

.discussion-header {
  display: flex;
  align-items: flex-start;
  gap: 1rem;
}

.upvote-section {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.2rem;
  min-width: 45px;
}

.upvote-btn {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  border: 2px solid rgba(255,255,255,0.15);
  background: transparent;
  color: #fff;
  font-size: 1.2rem;
  cursor: pointer;
  transition: 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
}

.upvote-btn:hover {
  border-color: rgba(99,102,241,0.5);
  background: rgba(99,102,241,0.15);
  transform: translateY(-2px);
}

.upvote-btn.upvoted {
  border-color: #6366f1;
  background: linear-gradient(135deg, rgba(99,102,241,0.3), rgba(236,72,153,0.3));
  color: #a5b4fc;
}

.upvote-count {
  font-size: 1rem;
  font-weight: 700;
  background: linear-gradient(135deg, #6366f1, #ec4899);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.discussion-avatar {
  width: 45px;
  height: 45px;
  border-radius: 12px;
  background: linear-gradient(135deg, #6366f1, #ec4899);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2rem;
  font-weight: 700;
  flex-shrink: 0;
}

.discussion-content {
  flex: 1;
  min-width: 0;
}

.discussion-title {
  font-size: 1.1rem;
  font-weight: 700;
  margin: 0 0 0.4rem;
  line-height: 1.3;
}

.discussion-preview {
  font-size: 0.95rem;
  opacity: 0.75;
  line-height: 1.5;
  margin: 0 0 0.8rem;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  white-space: pre-wrap;
}

.discussion-meta {
  display: flex;
  align-items: center;
  gap: 1rem;
  flex-wrap: wrap;
}

.meta-item {
  display: flex;
  align-items: center;
  gap: 0.3rem;
  font-size: 0.85rem;
  opacity: 0.7;
}

.category-tag {
  padding: 0.3rem 0.8rem;
  border-radius: 12px;
  font-size: 0.8rem;
  font-weight: 600;
  background: rgba(99,102,241,0.2);
  color: #a5b4fc;
}

.category-tag.switching { background: rgba(34,197,94,0.2); color: #86efac; }
.category-tag.bills { background: rgba(236,72,153,0.2); color: #f9a8d4; }
.category-tag.tips { background: rgba(251,191,36,0.2); color: #fde68a; }
.category-tag.suppliers { background: rgba(99,102,241,0.2); color: #a5b4fc; }
.category-tag.general { background: rgba(148,163,184,0.2); color: #cbd5e1; }

.replies-section {
  padding: 1rem 2rem 1.5rem;
  padding-left: 5.5rem;
  background: rgba(0,0,0,0.15);
  display: none;
}

.replies-section.visible {
  display: block;
  animation: slideDown 0.3s ease;
}

@keyframes slideDown {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

.reply-item {
  padding: 1rem;
  background: rgba(255,255,255,0.03);
  border-radius: 12px;
  margin-bottom: 0.8rem;
  border-left: 3px solid rgba(99,102,241,0.5);
  position: relative;
}

.reply-header {
  display: flex;
  align-items: center;
  gap: 0.8rem;
  margin-bottom: 0.5rem;
}

.reply-avatar {
  width: 30px;
  height: 30px;
  border-radius: 8px;
  background: linear-gradient(135deg, #6366f1, #ec4899);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.8rem;
  font-weight: 700;
}

.reply-author {
  font-weight: 600;
  font-size: 0.9rem;
}

.reply-time {
  font-size: 0.8rem;
  opacity: 0.6;
}

.reply-text {
  font-size: 0.95rem;
  line-height: 1.6;
  opacity: 0.9;
  margin: 0;
  white-space: pre-wrap;
}

.reply-upvote {
  position: absolute;
  top: 1rem;
  right: 1rem;
  display: flex;
  align-items: center;
  gap: 0.4rem;
}

.reply-upvote-btn {
  width: 28px;
  height: 28px;
  border-radius: 6px;
  border: 1px solid rgba(255,255,255,0.1);
  background: transparent;
  color: #fff;
  font-size: 0.9rem;
  cursor: pointer;
  transition: 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
}

.reply-upvote-btn:hover {
  border-color: rgba(99,102,241,0.5);
  background: rgba(99,102,241,0.15);
}

.reply-upvote-btn.upvoted {
  border-color: #6366f1;
  background: rgba(99,102,241,0.2);
  color: #a5b4fc;
}

.reply-upvote-count {
  font-size: 0.85rem;
  font-weight: 600;
  color: #a5b4fc;
}

.reply-input-wrapper {
  display: flex;
  gap: 0.8rem;
  margin-top: 1rem;
}

.reply-input-wrapper input {
  flex: 1;
  padding: 0.8rem 1rem;
  border-radius: 12px;
  border: 2px solid rgba(255,255,255,0.1);
  background: rgba(255,255,255,0.05);
  color: #fff;
  font-size: 0.95rem;
  font-family: inherit;
}

.reply-input-wrapper input:focus {
  outline: none;
  border-color: rgba(99,102,241,0.5);
}

.reply-btn {
  padding: 0.8rem 1.5rem;
  border: none;
  border-radius: 12px;
  background: linear-gradient(135deg, #6366f1, #ec4899);
  color: #fff;
  font-weight: 600;
  cursor: pointer;
  transition: 0.3s;
}

.reply-btn:hover {
  transform: translateY(-2px);
}

.reply-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.sidebar {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.sidebar-card {
  background: rgba(17,22,46,0.95);
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,0.08);
  box-shadow: 0 15px 40px rgba(0,0,0,0.3);
  padding: 1.5rem;
}

.sidebar-card h3 {
  margin: 0 0 1rem;
  font-size: 1.1rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.user-profile-card {
  text-align: center;
}

.user-avatar-large {
  width: 70px;
  height: 70px;
  border-radius: 16px;
  background: linear-gradient(135deg, #6366f1, #ec4899);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.8rem;
  font-weight: 700;
  margin: 0 auto 1rem;
}

.user-name {
  font-size: 1.2rem;
  font-weight: 700;
  margin-bottom: 0.3rem;
}

.user-joined {
  font-size: 0.85rem;
  opacity: 0.6;
  margin-bottom: 1rem;
}

.user-stats {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 0.5rem;
  margin-bottom: 1rem;
}

.user-stat {
  text-align: center;
  padding: 0.6rem;
  background: rgba(99,102,241,0.1);
  border-radius: 8px;
}

.user-stat-number {
  font-size: 1.2rem;
  font-weight: 700;
  background: linear-gradient(135deg, #6366f1, #ec4899);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.user-stat-label {
  font-size: 0.7rem;
  opacity: 0.7;
}

.change-name-btn {
  padding: 0.6rem 1.2rem;
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 8px;
  background: transparent;
  color: #fff;
  font-size: 0.85rem;
  cursor: pointer;
  transition: 0.3s;
}

.change-name-btn:hover {
  background: rgba(255,255,255,0.1);
}

.stats-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
}

.stat-item {
  text-align: center;
  padding: 1rem;
  background: rgba(99,102,241,0.1);
  border-radius: 12px;
}

.stat-number {
  font-size: 1.8rem;
  font-weight: 900;
  background: linear-gradient(135deg, #6366f1, #ec4899);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.stat-label {
  font-size: 0.8rem;
  opacity: 0.7;
  margin-top: 0.3rem;
}

.active-topic {
  padding: 0.8rem;
  background: rgba(255,255,255,0.03);
  border-radius: 10px;
  margin-bottom: 0.6rem;
  cursor: pointer;
  transition: 0.3s;
}

.active-topic:hover {
  background: rgba(99,102,241,0.15);
}

.active-topic:last-child {
  margin-bottom: 0;
}

.active-topic-title {
  font-size: 0.9rem;
  font-weight: 600;
  margin-bottom: 0.3rem;
  line-height: 1.3;
}

.active-topic-meta {
  font-size: 0.8rem;
  opacity: 0.6;
}

.guidelines-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.guidelines-list li {
  padding: 0.6rem 0;
  font-size: 0.9rem;
  opacity: 0.85;
  display: flex;
  align-items: flex-start;
  gap: 0.6rem;
  line-height: 1.4;
  border-bottom: 1px solid rgba(255,255,255,0.05);
}

.guidelines-list li:last-child {
  border-bottom: none;
}

.empty-state {
  text-align: center;
  padding: 4rem 2rem;
  opacity: 0.7;
}

.empty-state-icon {
  font-size: 4rem;
  margin-bottom: 1rem;
}

.empty-state h4 {
  font-size: 1.3rem;
  margin: 0 0 0.5rem;
}

.empty-state p {
  font-size: 1rem;
  opacity: 0.8;
}

.footer {
  background: #0c0e1f;
  text-align: center;
  padding: 3rem 2rem;
  color: white;
  position: relative;
  z-index: 5;
  margin-top: 4rem;
}
.footer p {
  opacity: 0.8;
  margin: 0.5rem 0;
}

.discussions-list::-webkit-scrollbar {
  width: 8px;
}

.discussions-list::-webkit-scrollbar-track {
  background: rgba(255,255,255,0.05);
}

.discussions-list::-webkit-scrollbar-thumb {
  background: rgba(99,102,241,0.3);
  border-radius: 4px;
}

.discussions-list::-webkit-scrollbar-thumb:hover {
  background: rgba(99,102,241,0.5);
}

.success-message {
  padding: 1rem;
  background: rgba(34,197,94,0.2);
  border: 1px solid rgba(34,197,94,0.3);
  border-radius: 12px;
  color: #86efac;
  text-align: center;
  margin-bottom: 1rem;
  display: none;
  animation: fadeIn 0.3s ease;
}

.error-message {
  padding: 1rem;
  background: rgba(239,68,68,0.2);
  border: 1px solid rgba(239,68,68,0.3);
  border-radius: 12px;
  color: #fca5a5;
  text-align: center;
  margin-bottom: 1rem;
  display: none;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.connection-status {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  background: rgba(0,0,0,0.2);
  border-radius: 8px;
  font-size: 0.8rem;
  margin-bottom: 1rem;
}

.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #22c55e;
}

.status-dot.offline {
  background: #ef4444;
}

.status-dot.syncing {
  background: #fbbf24;
  animation: pulse 1s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

@media (max-width: 1024px) {
  .content-grid {
    grid-template-columns: 1fr;
  }
  
  .sidebar {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  }
}

@media (max-width: 768px) {
  .main-container {
    padding: 6rem 1.5rem 3rem;
  }
  
  .page-header h1 {
    font-size: 2.5rem;
  }
  
  .page-header p {
    font-size: 1.05rem;
  }
  
  .top-logo {
    top: 20px;
    left: 20px;
  }
  .top-logo span:first-child {
    font-size: 1.8rem;
  }
  .top-logo span:last-child {
    font-size: 1.5rem;
  }
  
  .floating-symbols {
    display: none;
  }
  
  .new-post-section,
  .discussion-item {
    padding: 1.2rem 1.5rem;
  }
  
  .filter-tabs {
    padding: 1rem 1.5rem;
  }
  
  .sort-bar {
    padding: 0.8rem 1.5rem;
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .replies-section {
    padding-left: 1.5rem;
  }
  
  .sidebar {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 480px) {
  .main-container {
    padding: 5.5rem 1rem 2rem;
  }
  
  .page-header h1 {
    font-size: 2rem;
  }
  
  .top-logo {
    top: 15px;
    left: 15px;
    gap: 6px;
  }
  .top-logo span:first-child {
    font-size: 1.5rem;
  }
  .top-logo span:last-child {
    font-size: 1.2rem;
  }
  
  .back-home {
    font-size: 0.85rem;
    padding: 0.5rem 1rem;
  }
  
  .discussion-header {
    flex-wrap: wrap;
  }
  
  .upvote-section {
    order: -1;
    flex-direction: row;
    width: 100%;
    justify-content: flex-start;
    margin-bottom: 0.5rem;
  }
  
  .discussion-avatar {
    width: 40px;
    height: 40px;
  }
  
  .discussion-meta {
    gap: 0.6rem;
  }
  
  .reply-input-wrapper {
    flex-direction: column;
  }
  
  .stats-grid {
    grid-template-columns: 1fr 1fr;
    gap: 0.8rem;
  }
  
  .user-stats {
    grid-template-columns: repeat(3, 1fr);
  }
}
</style>
</head>

<body>

<!-- LOGO -->
<div class="top-logo">
  <span>‚úàÔ∏è‚ö°</span>
  <span>SwitchPilot</span>
</div>

<!-- ANIMATED GRID BACKGROUND -->
<div class="energy-grid"></div>

<!-- FLOATING SYMBOLS -->
<div class="floating-symbols">
  <div class="symbol">üí¨</div>
  <div class="symbol">‚ö°</div>
  <div class="symbol">üí°</div>
  <div class="symbol">üîå</div>
</div>

<div class="main-container">

  <!-- PAGE HEADER -->
  <div class="page-header">
    <a href="index.html" class="back-home">‚Üê Back Home</a>
    <h1>üí¨ Community Discussions</h1>
    <p>Share your energy experiences, ask questions, and learn from fellow pilots navigating the UK energy market together.</p>
  </div>

  <!-- CONTENT GRID -->
  <div class="content-grid">

    <!-- MAIN DISCUSSIONS PANEL -->
    <div class="discussions-panel">

      <!-- NEW POST FORM -->
      <div class="new-post-section">
        <h3>‚úçÔ∏è Start a Discussion</h3>
        <div class="connection-status">
          <div class="status-dot" id="connectionDot"></div>
          <span id="connectionText">Connected - discussions sync across all users</span>
        </div>
        <div id="successMessage" class="success-message">
          üéâ Your discussion has been posted successfully!
        </div>
        <div id="errorMessage" class="error-message">
          ‚ö†Ô∏è Could not connect to server. Your post will be saved locally.
        </div>
        <form id="newPostForm" onsubmit="handleNewPost(event)">
          <div class="form-group">
            <label for="postName">Your Name (or nickname)</label>
            <input type="text" id="postName" placeholder="e.g. EnergyExplorer" required maxlength="50" autocomplete="name" />
          </div>
          <div class="form-group">
            <label for="postCategory">Category</label>
            <select id="postCategory" required>
              <option value="">Select a category...</option>
              <option value="switching">üîÑ Switching Experiences</option>
              <option value="bills">üí∑ Understanding Bills</option>
              <option value="tips">üí° Money-Saving Tips</option>
              <option value="suppliers">üè¢ Supplier Reviews</option>
              <option value="general">üí¨ General Chat</option>
            </select>
          </div>
          <div class="form-group">
            <label for="postTitle">Discussion Title</label>
            <input type="text" id="postTitle" placeholder="What would you like to discuss?" required maxlength="150" />
          </div>
          <div class="form-group">
            <label for="postContent">Your Message</label>
            <textarea id="postContent" placeholder="Share your thoughts, questions, or experiences..." required maxlength="2000"></textarea>
          </div>
          <button type="submit" class="submit-btn" id="submitBtn">Post Discussion</button>
        </form>
      </div>

      <!-- FILTER TABS -->
      <div class="filter-tabs" role="tablist" aria-label="Filter discussions by category">
        <button class="filter-tab active" data-category="all" role="tab" aria-selected="true">All Topics</button>
        <button class="filter-tab" data-category="switching" role="tab" aria-selected="false">üîÑ Switching</button>
        <button class="filter-tab" data-category="bills" role="tab" aria-selected="false">üí∑ Bills</button>
        <button class="filter-tab" data-category="tips" role="tab" aria-selected="false">üí° Tips</button>
        <button class="filter-tab" data-category="suppliers" role="tab" aria-selected="false">üè¢ Suppliers</button>
        <button class="filter-tab" data-category="general" role="tab" aria-selected="false">üí¨ General</button>
      </div>

      <!-- SORT BAR -->
      <div class="sort-bar">
        <span id="discussionCount" aria-live="polite">Loading discussions...</span>
        <div class="sort-options" role="group" aria-label="Sort discussions">
          <button class="sort-btn active" data-sort="newest" aria-pressed="true">Newest</button>
          <button class="sort-btn" data-sort="top" aria-pressed="false">Top Voted</button>
          <button class="sort-btn" data-sort="active" aria-pressed="false">Most Active</button>
        </div>
      </div>

      <!-- DISCUSSIONS LIST -->
      <div class="discussions-list" id="discussionsList" role="feed" aria-label="Community discussions" aria-busy="true">
        <div class="loading-state">
          <div class="loading-spinner" role="status" aria-label="Loading"></div>
          <p>Loading discussions...</p>
        </div>
      </div>

    </div>

    <!-- SIDEBAR -->
    <div class="sidebar">

      <!-- USER PROFILE -->
      <div class="sidebar-card user-profile-card">
        <div class="user-avatar-large" id="userAvatar">?</div>
        <div class="user-name" id="userName">Set Your Name</div>
        <div class="user-joined" id="userJoined">Click below to get started</div>
        <div class="user-stats">
          <div class="user-stat">
            <div class="user-stat-number" id="userPosts">0</div>
            <div class="user-stat-label">Posts</div>
          </div>
          <div class="user-stat">
            <div class="user-stat-number" id="userReplies">0</div>
            <div class="user-stat-label">Replies</div>
          </div>
          <div class="user-stat">
            <div class="user-stat-number" id="userUpvotes">0</div>
            <div class="user-stat-label">Upvotes</div>
          </div>
        </div>
        <button class="change-name-btn" onclick="changeName()">Change Name</button>
        <button class="change-name-btn" onclick="clearAllData()" style="margin-top: 0.5rem; background: rgba(239,68,68,0.2); border-color: rgba(239,68,68,0.3);">Clear All Data</button>
      </div>

      <!-- COMMUNITY STATS -->
      <div class="sidebar-card">
        <h3>üìä Community Stats</h3>
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-number" id="totalDiscussions">0</div>
            <div class="stat-label">Discussions</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="totalReplies">0</div>
            <div class="stat-label">Replies</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="totalMembers">0</div>
            <div class="stat-label">Members</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="totalUpvotes">0</div>
            <div class="stat-label">Upvotes</div>
          </div>
        </div>
      </div>

      <!-- TRENDING TOPICS -->
      <div class="sidebar-card">
        <h3>üî• Top Discussions</h3>
        <div id="activeTopics">
        </div>
      </div>

      <!-- COMMUNITY GUIDELINES -->
      <div class="sidebar-card">
        <h3>üìã Guidelines</h3>
        <ul class="guidelines-list">
          <li>‚úÖ Be respectful and constructive</li>
          <li>‚úÖ Share real experiences</li>
          <li>‚úÖ Help others save money</li>
          <li>‚ö†Ô∏è No spam or promotions</li>
          <li>‚ö†Ô∏è No personal account details</li>
        </ul>
      </div>

    </div>

  </div>

</div>

<footer class="footer">
  <p>üíå Weekly energy insights delivered to your inbox</p>
  <p>¬© 2025 SwitchPilot. Making energy bills make sense.</p>
</footer>

<script>
const COMMUNITY_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx2sd1Tgj8AMak2yEYxCFasS1UdpMTkhAn5vG2f835o3CbdXxQ4pKPH3BQBwspAdV3sMA/exec';

const STORAGE_KEY = 'switchpilot_discussions';
const USER_KEY = 'switchpilot_user';
const UPVOTES_KEY = 'switchpilot_upvotes';
const REPLY_UPVOTES_KEY = 'switchpilot_reply_upvotes';

let discussions = [];
let currentFilter = 'all';
let currentSort = 'newest';
let isOnline = true;
let currentUser = null;

function initUser() {
  const stored = localStorage.getItem(USER_KEY);
  if (stored) {
    try {
      currentUser = JSON.parse(stored);
    } catch (e) {
      console.warn('Could not parse stored user, creating new user');
      currentUser = null;
    }
  }
  
  if (!currentUser) {
    currentUser = {
      id: 'user_' + Date.now() + '_' + Math.random().toString(36).substring(2, 11),
      name: null,
      joinedAt: Date.now(),
      posts: 0,
      replies: 0,
      upvotesReceived: 0
    };
    saveUser();
  }
  updateUserDisplay();
}

function saveUser() {
  localStorage.setItem(USER_KEY, JSON.stringify(currentUser));
}

function updateUserDisplay() {
  const avatar = document.getElementById('userAvatar');
  const name = document.getElementById('userName');
  const joined = document.getElementById('userJoined');
  
  if (currentUser.name) {
    avatar.textContent = getInitials(currentUser.name);
    name.textContent = currentUser.name;
    joined.textContent = 'Member since ' + formatDate(currentUser.joinedAt);
    document.getElementById('postName').value = currentUser.name;
  } else {
    avatar.textContent = '?';
    name.textContent = 'Set Your Name';
    joined.textContent = 'Click below to get started';
  }
  
  document.getElementById('userPosts').textContent = currentUser.posts || 0;
  document.getElementById('userReplies').textContent = currentUser.replies || 0;
  document.getElementById('userUpvotes').textContent = currentUser.upvotesReceived || 0;
}

function changeName() {
  const newName = prompt('Enter your display name:', currentUser.name || '');
  if (newName && newName.trim()) {
    currentUser.name = newName.trim();
    saveUser();
    updateUserDisplay();
  }
}

function clearAllData() {
  if (confirm('This will delete all discussions, your profile, and reset everything. Are you sure?')) {
    localStorage.removeItem(STORAGE_KEY);
    localStorage.removeItem(USER_KEY);
    localStorage.removeItem(UPVOTES_KEY);
    localStorage.removeItem(REPLY_UPVOTES_KEY);
    location.reload();
  }
}

function getUserUpvotes() {
  return JSON.parse(localStorage.getItem(UPVOTES_KEY) || '[]');
}

function saveUserUpvotes(upvotes) {
  localStorage.setItem(UPVOTES_KEY, JSON.stringify(upvotes));
}

function getUserReplyUpvotes() {
  return JSON.parse(localStorage.getItem(REPLY_UPVOTES_KEY) || '[]');
}

function saveUserReplyUpvotes(upvotes) {
  localStorage.setItem(REPLY_UPVOTES_KEY, JSON.stringify(upvotes));
}

function hasUpvoted(discussionId) {
  return getUserUpvotes().includes(discussionId);
}

function hasUpvotedReply(replyId) {
  return getUserReplyUpvotes().includes(replyId);
}

async function toggleUpvote(discussionId, event) {
  event.stopPropagation();
  
  const upvotes = getUserUpvotes();
  const discussion = discussions.find(d => d.id === discussionId);
  if (!discussion) return;
  
  const alreadyUpvoted = upvotes.includes(discussionId);
  
  if (alreadyUpvoted) {
    const index = upvotes.indexOf(discussionId);
    upvotes.splice(index, 1);
    discussion.upvotes = Math.max(0, (discussion.upvotes || 0) - 1);
  } else {
    upvotes.push(discussionId);
    discussion.upvotes = (discussion.upvotes || 0) + 1;
  }
  
  saveUserUpvotes(upvotes);
  saveDiscussionsLocal(discussions);
  
  const btn = document.querySelector(`.upvote-btn[data-id="${discussionId}"]`);
  const count = document.querySelector(`.upvote-count[data-id="${discussionId}"]`);
  
  if (btn) {
    btn.classList.toggle('upvoted', !alreadyUpvoted);
  }
  if (count) {
    count.textContent = discussion.upvotes;
  }
  
  syncUpvoteToServer(discussionId, !alreadyUpvoted);
  updateStats();
}

async function toggleReplyUpvote(discussionId, replyId, event) {
  event.stopPropagation();
  
  const upvotes = getUserReplyUpvotes();
  const discussion = discussions.find(d => d.id === discussionId);
  if (!discussion) return;
  
  const reply = discussion.replies?.find(r => r.id === replyId);
  if (!reply) return;
  
  const alreadyUpvoted = upvotes.includes(replyId);
  
  if (alreadyUpvoted) {
    const index = upvotes.indexOf(replyId);
    upvotes.splice(index, 1);
    reply.upvotes = Math.max(0, (reply.upvotes || 0) - 1);
  } else {
    upvotes.push(replyId);
    reply.upvotes = (reply.upvotes || 0) + 1;
  }
  
  saveUserReplyUpvotes(upvotes);
  saveDiscussionsLocal(discussions);
  
  const btn = document.querySelector(`.reply-upvote-btn[data-reply-id="${replyId}"]`);
  const count = document.querySelector(`.reply-upvote-count[data-reply-id="${replyId}"]`);
  
  if (btn) btn.classList.toggle('upvoted', !alreadyUpvoted);
  if (count) count.textContent = reply.upvotes || 0;
  
  updateStats();
}

async function syncUpvoteToServer(discussionId, isUpvote) {
  try {
    await fetch(COMMUNITY_SCRIPT_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'upvote',
        discussionId: discussionId,
        isUpvote: isUpvote,
        userId: currentUser.id
      })
    });
  } catch (err) {
    console.log('Could not sync upvote to server:', err);
  }
}

const sampleDiscussions = [];

function loadDiscussionsLocal() {
  const stored = localStorage.getItem(STORAGE_KEY);
  if (stored) {
    try {
      return JSON.parse(stored);
    } catch (e) {
      console.warn('Could not parse stored discussions, starting fresh');
    }
  }
  localStorage.setItem(STORAGE_KEY, JSON.stringify(sampleDiscussions));
  return sampleDiscussions;
}

function saveDiscussionsLocal(data) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

async function loadDiscussionsFromServer() {
  try {
    const response = await fetch(COMMUNITY_SCRIPT_URL + '?action=getDiscussions');
    if (!response.ok) throw new Error('Server error');
    
    const data = await response.json();
    if (data.discussions && data.discussions.length > 0) {
      discussions = mergeDiscussions(data.discussions, loadDiscussionsLocal());
      saveDiscussionsLocal(discussions);
      setOnlineStatus(true);
      return discussions;
    }
  } catch (err) {
    console.log('Could not load from server, using local data:', err);
    setOnlineStatus(false);
  }
  
  discussions = loadDiscussionsLocal();
  return discussions;
}

function mergeDiscussions(serverData, localData) {
  const merged = new Map();
  
  localData.forEach(d => merged.set(d.id, d));
  
  serverData.forEach(d => {
    const existing = merged.get(d.id);
    if (existing) {
      d.upvotes = Math.max(d.upvotes || 0, existing.upvotes || 0);
      if (d.replies && existing.replies) {
        const replyMap = new Map();
        existing.replies.forEach(r => replyMap.set(r.id, r));
        d.replies.forEach(r => {
          const existingReply = replyMap.get(r.id);
          if (existingReply) {
            r.upvotes = Math.max(r.upvotes || 0, existingReply.upvotes || 0);
          }
          replyMap.set(r.id, r);
        });
        d.replies = Array.from(replyMap.values());
      }
    }
    merged.set(d.id, d);
  });
  
  return Array.from(merged.values());
}

function setOnlineStatus(online) {
  isOnline = online;
  const dot = document.getElementById('connectionDot');
  const text = document.getElementById('connectionText');
  
  if (online) {
    dot.className = 'status-dot';
    text.textContent = 'Connected - discussions sync across all users';
  } else {
    dot.className = 'status-dot offline';
    text.textContent = 'Offline - discussions saved locally';
  }
}

function getInitials(name) {
  return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
}

function formatTime(timestamp) {
  const diff = Date.now() - timestamp;
  const minutes = Math.floor(diff / 60000);
  const hours = Math.floor(diff / 3600000);
  const days = Math.floor(diff / 86400000);
  
  if (minutes < 1) return 'Just now';
  if (minutes < 60) return `${minutes}m ago`;
  if (hours < 24) return `${hours}h ago`;
  if (days < 7) return `${days}d ago`;
  return formatDate(timestamp);
}

function formatDate(timestamp) {
  return new Date(timestamp).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
}

function getCategoryLabel(category) {
  const labels = {
    switching: 'üîÑ Switching',
    bills: 'üí∑ Bills',
    tips: 'üí° Tips',
    suppliers: 'üè¢ Suppliers',
    general: 'üí¨ General'
  };
  return labels[category] || category;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function sortDiscussions(data, sortBy) {
  const sorted = [...data];
  
  sorted.sort((a, b) => {
    if (a.pinned && !b.pinned) return -1;
    if (!a.pinned && b.pinned) return 1;
    
    switch (sortBy) {
      case 'top':
        return (b.upvotes || 0) - (a.upvotes || 0);
      case 'active':
        const aActivity = Math.max(a.timestamp, ...(a.replies || []).map(r => r.timestamp));
        const bActivity = Math.max(b.timestamp, ...(b.replies || []).map(r => r.timestamp));
        return bActivity - aActivity;
      case 'newest':
      default:
        return b.timestamp - a.timestamp;
    }
  });
  
  return sorted;
}

function renderDiscussions() {
  const container = document.getElementById('discussionsList');
  
  let filtered = currentFilter === 'all' 
    ? discussions 
    : discussions.filter(d => d.category === currentFilter);
  
  filtered = sortDiscussions(filtered, currentSort);
  
  document.getElementById('discussionCount').textContent = 
    `${filtered.length} discussion${filtered.length !== 1 ? 's' : ''}`;
  
  if (filtered.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üí¨</div>
        <h4>No discussions yet</h4>
        <p>Be the first to start a conversation!</p>
      </div>
    `;
    return;
  }
  
  const userUpvotes = getUserUpvotes();
  const userReplyUpvotes = getUserReplyUpvotes();
  
  container.innerHTML = filtered.map(discussion => `
    <div class="discussion-item ${discussion.pinned ? 'pinned' : ''}" data-id="${discussion.id}" onclick="toggleDiscussion('${discussion.id}')">
      ${discussion.pinned ? '<div class="pinned-badge">üìå Pinned</div>' : ''}
      <div class="discussion-header">
        <div class="upvote-section" onclick="event.stopPropagation()">
          <button class="upvote-btn ${userUpvotes.includes(discussion.id) ? 'upvoted' : ''}" 
                  data-id="${discussion.id}" 
                  onclick="toggleUpvote('${discussion.id}', event)"
                  title="Upvote this discussion">
            ‚ñ≤
          </button>
          <span class="upvote-count" data-id="${discussion.id}">${discussion.upvotes || 0}</span>
        </div>
        <div class="discussion-avatar">${discussion.avatar || getInitials(discussion.name)}</div>
        <div class="discussion-content">
          <h4 class="discussion-title">${escapeHtml(discussion.title)}</h4>
          <p class="discussion-preview">${escapeHtml(discussion.content)}</p>
          <div class="discussion-meta">
            <span class="category-tag ${discussion.category}">${getCategoryLabel(discussion.category)}</span>
            <span class="meta-item">üë§ ${escapeHtml(discussion.name)}</span>
            <span class="meta-item">üïê ${formatTime(discussion.timestamp)}</span>
            <span class="meta-item">üí¨ ${discussion.replies?.length || 0}</span>
          </div>
        </div>
      </div>
    </div>
    <div class="replies-section" id="replies-${discussion.id}">
      ${(discussion.replies || []).map(reply => `
        <div class="reply-item">
          <div class="reply-upvote">
            <button class="reply-upvote-btn ${userReplyUpvotes.includes(reply.id) ? 'upvoted' : ''}" 
                    data-reply-id="${reply.id}"
                    onclick="toggleReplyUpvote('${discussion.id}', '${reply.id}', event)"
                    title="Upvote this reply">
              ‚ñ≤
            </button>
            <span class="reply-upvote-count" data-reply-id="${reply.id}">${reply.upvotes || 0}</span>
          </div>
          <div class="reply-header">
            <div class="reply-avatar">${reply.avatar || getInitials(reply.name)}</div>
            <span class="reply-author">${escapeHtml(reply.name)}</span>
            <span class="reply-time">${formatTime(reply.timestamp)}</span>
          </div>
          <p class="reply-text">${escapeHtml(reply.text)}</p>
        </div>
      `).join('')}
      <div class="reply-input-wrapper">
        <input type="text" placeholder="Write a reply..." id="reply-input-${discussion.id}" onkeypress="handleReplyKeypress(event, '${discussion.id}')" />
        <button class="reply-btn" onclick="submitReply('${discussion.id}')">Reply</button>
      </div>
    </div>
  `).join('');
}

function toggleDiscussion(id) {
  const repliesSection = document.getElementById(`replies-${id}`);
  const discussionItem = document.querySelector(`.discussion-item[data-id="${id}"]`);
  
  document.querySelectorAll('.replies-section.visible').forEach(section => {
    if (section.id !== `replies-${id}`) {
      section.classList.remove('visible');
    }
  });
  document.querySelectorAll('.discussion-item.expanded').forEach(item => {
    if (item.dataset.id !== id) {
      item.classList.remove('expanded');
    }
  });
  
  repliesSection.classList.toggle('visible');
  discussionItem.classList.toggle('expanded');
}

async function handleNewPost(e) {
  e.preventDefault();
  
  const submitBtn = document.getElementById('submitBtn');
  submitBtn.disabled = true;
  submitBtn.textContent = 'Posting...';
  
  const name = document.getElementById('postName').value.trim();
  const category = document.getElementById('postCategory').value;
  const title = document.getElementById('postTitle').value.trim();
  const content = document.getElementById('postContent').value.trim();
  
  if (!name || !category || !title || !content) {
    const errorEl = document.getElementById('errorMessage');
    errorEl.textContent = '‚ö†Ô∏è Please fill in all fields before posting.';
    errorEl.style.display = 'block';
    setTimeout(() => {
      errorEl.style.display = 'none';
      errorEl.textContent = '‚ö†Ô∏è Could not connect to server. Your post will be saved locally.';
    }, 3000);
    submitBtn.disabled = false;
    submitBtn.textContent = 'Post Discussion';
    return;
  }
  
  if (name !== currentUser.name) {
    currentUser.name = name;
    saveUser();
    updateUserDisplay();
  }
  
  const newDiscussion = {
    id: 'disc_' + Date.now() + '_' + Math.random().toString(36).substring(2, 11),
    name: name,
    userId: currentUser.id,
    avatar: getInitials(name),
    category: category,
    title: title,
    content: content,
    timestamp: Date.now(),
    upvotes: 0,
    replies: []
  };
  
  discussions.unshift(newDiscussion);
  saveDiscussionsLocal(discussions);
  
  currentUser.posts = (currentUser.posts || 0) + 1;
  saveUser();
  updateUserDisplay();
  
  try {
    await fetch(COMMUNITY_SCRIPT_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'addDiscussion',
        discussion: newDiscussion
      })
    });
    
    document.getElementById('successMessage').style.display = 'block';
    setTimeout(() => {
      document.getElementById('successMessage').style.display = 'none';
    }, 3000);
  } catch (err) {
    console.log('Could not sync to server:', err);
    document.getElementById('errorMessage').style.display = 'block';
    setTimeout(() => {
      document.getElementById('errorMessage').style.display = 'none';
    }, 3000);
  }
  
  document.getElementById('newPostForm').reset();
  document.getElementById('postName').value = currentUser.name || '';
  
  submitBtn.disabled = false;
  submitBtn.textContent = 'Post Discussion';
  
  renderDiscussions();
  updateStats();
  updateActiveTopics();
}

async function submitReply(discussionId) {
  const input = document.getElementById(`reply-input-${discussionId}`);
  const text = input.value.trim();
  
  if (!text) return;
  
  if (!currentUser.name) {
    const name = prompt('Enter your name for this reply:');
    if (!name) return;
    currentUser.name = name.trim();
    saveUser();
    updateUserDisplay();
  }
  
  const discussion = discussions.find(d => d.id === discussionId);
  if (!discussion) return;
  
  const newReply = {
    id: 'reply_' + Date.now() + '_' + Math.random().toString(36).substring(2, 11),
    name: currentUser.name,
    userId: currentUser.id,
    avatar: getInitials(currentUser.name),
    text: text,
    timestamp: Date.now(),
    upvotes: 0
  };
  
  if (!discussion.replies) discussion.replies = [];
  discussion.replies.push(newReply);
  
  saveDiscussionsLocal(discussions);
  
  currentUser.replies = (currentUser.replies || 0) + 1;
  saveUser();
  updateUserDisplay();
  
  try {
    await fetch(COMMUNITY_SCRIPT_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'addReply',
        discussionId: discussionId,
        reply: newReply
      })
    });
  } catch (err) {
    console.log('Could not sync reply to server:', err);
  }
  
  input.value = '';
  renderDiscussions();
  updateStats();
  
  setTimeout(() => {
    const repliesSection = document.getElementById(`replies-${discussionId}`);
    const discussionItem = document.querySelector(`.discussion-item[data-id="${discussionId}"]`);
    repliesSection.classList.add('visible');
    discussionItem.classList.add('expanded');
  }, 0);
}

function handleReplyKeypress(e, discussionId) {
  if (e.key === 'Enter') {
    submitReply(discussionId);
  }
}

function updateStats() {
  const totalReplies = discussions.reduce((sum, d) => sum + (d.replies?.length || 0), 0);
  const totalUpvotes = discussions.reduce((sum, d) => {
    const discussionUpvotes = d.upvotes || 0;
    const replyUpvotes = (d.replies || []).reduce((rs, r) => rs + (r.upvotes || 0), 0);
    return sum + discussionUpvotes + replyUpvotes;
  }, 0);
  
  const members = new Set();
  discussions.forEach(d => {
    members.add(d.name.toLowerCase());
    (d.replies || []).forEach(r => members.add(r.name.toLowerCase()));
  });
  
  document.getElementById('totalDiscussions').textContent = discussions.length;
  document.getElementById('totalReplies').textContent = totalReplies;
  document.getElementById('totalMembers').textContent = members.size;
  document.getElementById('totalUpvotes').textContent = totalUpvotes;
}

function updateActiveTopics() {
  const container = document.getElementById('activeTopics');
  
  const sorted = [...discussions]
    .filter(d => !d.pinned)
    .sort((a, b) => {
      const aScore = (a.upvotes || 0) + (a.replies?.length || 0) * 2;
      const bScore = (b.upvotes || 0) + (b.replies?.length || 0) * 2;
      return bScore - aScore;
    })
    .slice(0, 4);
  
  if (sorted.length === 0) {
    container.innerHTML = '<p style="opacity: 0.6; font-size: 0.9rem;">No discussions yet. Be the first!</p>';
    return;
  }
  
  container.innerHTML = sorted.map(d => `
    <div class="active-topic" onclick="scrollToDiscussion('${d.id}')">
      <div class="active-topic-title">${escapeHtml(d.title.slice(0, 45))}${d.title.length > 45 ? '...' : ''}</div>
      <div class="active-topic-meta">‚ñ≤ ${d.upvotes || 0} ‚Ä¢ üí¨ ${d.replies?.length || 0}</div>
    </div>
  `).join('');
}

function scrollToDiscussion(id) {
  const element = document.querySelector(`.discussion-item[data-id="${id}"]`);
  if (element) {
    element.scrollIntoView({ behavior: 'smooth', block: 'center' });
    toggleDiscussion(id);
  }
}

document.querySelectorAll('.filter-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.filter-tab').forEach(t => {
      t.classList.remove('active');
      t.setAttribute('aria-selected', 'false');
    });
    tab.classList.add('active');
    tab.setAttribute('aria-selected', 'true');
    currentFilter = tab.dataset.category;
    renderDiscussions();
  });
});

document.querySelectorAll('.sort-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.sort-btn').forEach(b => {
      b.classList.remove('active');
      b.setAttribute('aria-pressed', 'false');
    });
    btn.classList.add('active');
    btn.setAttribute('aria-pressed', 'true');
    currentSort = btn.dataset.sort;
    renderDiscussions();
  });
});

async function init() {
  initUser();
  
  const discussionsList = document.getElementById('discussionsList');
  
  discussionsList.setAttribute('aria-busy', 'true');
  discussionsList.innerHTML = `
    <div class="loading-state">
      <div class="loading-spinner" role="status" aria-label="Loading"></div>
      <p>Loading discussions...</p>
    </div>
  `;
  
  discussions = await loadDiscussionsFromServer();
  
  discussionsList.setAttribute('aria-busy', 'false');
  
  renderDiscussions();
  updateStats();
  updateActiveTopics();
  
  setInterval(async () => {
    const serverDiscussions = await loadDiscussionsFromServer();
    if (serverDiscussions) {
      renderDiscussions();
      updateStats();
      updateActiveTopics();
    }
  }, 30000);
}

document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
