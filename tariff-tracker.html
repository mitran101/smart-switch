<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Tariff Tracker | SwitchPilot</title>

<!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-WEQ6VBT567"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-WEQ6VBT567');
</script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0c0e1f 0%, #1a1d3a 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        .container { max-width: 1200px; margin: 0 auto; }

        h1 {
            text-align: center;
            background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .subtitle { text-align: center; color: #94a3b8; margin-bottom: 8px; font-size: 1.1rem; }
        .updated { text-align: center; color: #64748b; font-size: 0.9rem; margin-bottom: 30px; }

        /* Info Banner */
        .info-banner {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.15), rgba(236, 72, 153, 0.15));
            border: 1px solid rgba(168, 85, 247, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .info-banner .icon { font-size: 2rem; }
        .info-banner .text h3 { color: #e0e0e0; margin-bottom: 5px; }
        .info-banner .text p { color: #94a3b8; font-size: 0.9rem; line-height: 1.5; }

        /* Input Section */
        .input-section {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(168, 85, 247, 0.3);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        label { display: block; color: #cbd5e1; font-weight: 500; margin-bottom: 8px; font-size: 0.9rem; }
        
        select, input[type="number"] {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(168, 85, 247, 0.3);
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 0.95rem;
        }
        select:focus, input:focus { outline: none; border-color: #a855f7; }
        select option { background: #1a1d3a; }

        .preset-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .preset-btn {
            flex: 1;
            min-width: 120px;
            padding: 10px 15px;
            border: 1px solid rgba(168, 85, 247, 0.3);
            background: rgba(255, 255, 255, 0.05);
            color: #cbd5e1;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85rem;
        }
        .preset-btn:hover {
            border-color: #a855f7;
            background: rgba(168, 85, 247, 0.2);
        }

        /* Chart Section */
        .chart-section {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(168, 85, 247, 0.3);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
        }
        .chart-section h2 {
            color: #e0e0e0;
            font-size: 1.3rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .chart-container { position: relative; height: 300px; }

        /* Summary Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(168, 85, 247, 0.3);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        .stat-card.best { border-color: #22c55e; background: rgba(34, 197, 94, 0.1); }
        .stat-card .value { font-size: 2rem; font-weight: 700; color: #a855f7; }
        .stat-card.best .value { color: #22c55e; }
        .stat-card .label { color: #94a3b8; font-size: 0.85rem; margin-top: 5px; }

        /* Tariff Cards */
        .section-title {
            color: #e0e0e0;
            font-size: 1.3rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tariffs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .tariff-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(168, 85, 247, 0.3);
            border-radius: 16px;
            padding: 25px;
            position: relative;
            transition: all 0.3s;
        }
        .tariff-card:hover {
            transform: translateY(-5px);
            border-color: #a855f7;
            box-shadow: 0 10px 30px rgba(168, 85, 247, 0.2);
        }
        .tariff-card.best {
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.05);
        }

        .best-badge {
            position: absolute;
            top: -12px;
            right: 20px;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .rank-badge {
            position: absolute;
            top: 20px;
            left: -10px;
            width: 35px;
            height: 35px;
            background: linear-gradient(135deg, #a855f7, #ec4899);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .supplier-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            margin-left: 25px;
        }
        .supplier-name { font-size: 1.4rem; font-weight: 600; color: #f1f5f9; }
        .tariff-name { color: #94a3b8; font-size: 0.9rem; margin-top: 3px; }
        .annual-cost { text-align: right; }
        .cost-amount { font-size: 2rem; font-weight: 700; color: #a855f7; }
        .tariff-card.best .cost-amount { color: #22c55e; }
        .cost-label { font-size: 0.75rem; color: #64748b; }

        .savings-tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-top: 5px;
        }
        .savings-tag.positive { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .savings-tag.negative { background: rgba(239, 68, 68, 0.2); color: #ef4444; }

        .rates-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }
        .rate-item { }
        .rate-label { font-size: 0.7rem; color: #64748b; text-transform: uppercase; }
        .rate-value { font-size: 0.95rem; color: #e0e0e0; font-weight: 500; }

        .card-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 15px 0;
        }
        .badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .badge.green { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .badge.blue { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .badge.yellow { background: rgba(234, 179, 8, 0.2); color: #eab308; }
        .badge.purple { background: rgba(168, 85, 247, 0.2); color: #a855f7; }

        .pros-cons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        .pros h4 { color: #22c55e; font-size: 0.85rem; margin-bottom: 8px; }
        .cons h4 { color: #ef4444; font-size: 0.85rem; margin-bottom: 8px; }
        .pros ul, .cons ul { list-style: none; font-size: 0.8rem; color: #94a3b8; }
        .pros li, .cons li { padding: 3px 0; }
        .pros li::before { content: "‚úì "; color: #22c55e; }
        .cons li::before { content: "‚úó "; color: #ef4444; }

        /* Price Cap Section */
        .price-cap-section {
            background: linear-gradient(135deg, rgba(234, 179, 8, 0.1), rgba(249, 115, 22, 0.1));
            border: 1px solid rgba(234, 179, 8, 0.3);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
        }
        .price-cap-section h2 {
            color: #fbbf24;
            font-size: 1.2rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .price-cap-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        .cap-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        .cap-item .value { font-size: 1.5rem; font-weight: 700; color: #fbbf24; }
        .cap-item .label { font-size: 0.8rem; color: #94a3b8; margin-top: 5px; }

        /* Explainer Section */
        .explainer-section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
        }
        .explainer-section h2 {
            color: #e0e0e0;
            font-size: 1.2rem;
            margin-bottom: 20px;
        }
        .explainer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .explainer-item {
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
        }
        .explainer-item h3 {
            color: #a855f7;
            font-size: 1rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .explainer-item p { color: #94a3b8; font-size: 0.85rem; line-height: 1.5; }

        .footer {
            text-align: center;
            padding: 20px;
            color: #64748b;
            font-size: 0.85rem;
        }
        .footer a { color: #a855f7; text-decoration: none; }

        .elec-only-warning {
            background: rgba(234, 179, 8, 0.1);
            border: 1px solid rgba(234, 179, 8, 0.3);
            color: #eab308;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            margin-top: 10px;
        }

        .loading { text-align: center; padding: 40px; color: #94a3b8; }
        .error { text-align: center; padding: 40px; color: #ef4444; }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚ö° Energy Tariff Tracker</h1>
        <p class="subtitle">Compare the cheapest energy deals - updated every weekday</p>
        <p class="updated">Last updated: <span id="lastUpdated">Loading...</span></p>

        <!-- Info Banner -->
        <div class="info-banner">
            <div class="icon">üí°</div>
            <div class="text">
                <h3>Price cap rising to ¬£1,758 in January!*</h3>
                <p>Fixed deals are currently beating the cap. Lock in a rate now before the January increase. We compare tariffs daily from multiple suppliers.</p>
                <p style="font-size: 0.75rem; color: #64748b; margin-top: 8px;">*UK average based on Ofgem typical consumption (2,700 kWh elec + 11,500 kWh gas). Varies by region.</p>
            </div>
        </div>

        <!-- Input Section -->
        <div class="input-section">
            <p style="color: #94a3b8; margin-bottom: 20px; font-size: 0.9rem;">Enter your actual usage from a recent bill, or just pick your household size below for an estimate.</p>
            <div class="input-grid">
                <div>
                    <label>üìç Your Region</label>
                    <select id="region">
                        <option value="London">London</option>
                        <option value="South East">South East</option>
                        <option value="South West">South West</option>
                        <option value="East Midlands">East Midlands</option>
                        <option value="West Midlands">West Midlands</option>
                        <option value="Eastern">Eastern</option>
                        <option value="North West">North West</option>
                        <option value="North East">North East</option>
                        <option value="Yorkshire">Yorkshire</option>
                        <option value="Southern">Southern</option>
                        <option value="South Wales">South Wales</option>
                        <option value="North Wales & Merseyside">North Wales & Merseyside</option>
                        <option value="South Scotland">South Scotland</option>
                        <option value="North Scotland">North Scotland</option>
                    </select>
                </div>
                <div>
                    <label>‚ö° Electricity (kWh/year)</label>
                    <input type="number" id="elecUsage" value="2700">
                </div>
                <div>
                    <label>üî• Gas (kWh/year)</label>
                    <input type="number" id="gasUsage" value="11500">
                </div>
                <div>
                    <label>üè† Fuel Type</label>
                    <select id="fuelType">
                        <option value="dual">Dual Fuel</option>
                        <option value="elec">Electricity Only</option>
                    </select>
                </div>
            </div>
            <p style="color: #cbd5e1; font-size: 0.9rem; margin-bottom: 10px; margin-top: 20px;">Or pick your household size:</p>
            <div class="preset-buttons">
                <button class="preset-btn" data-elec="1800" data-gas="7500">üè¢ Small (1-2 bed)</button>
                <button class="preset-btn" data-elec="2700" data-gas="11500">üè† Medium (Ofgem typical)</button>
                <button class="preset-btn" data-elec="4300" data-gas="17000">üè° Large (4+ bed)</button>
                <button class="preset-btn" data-elec="2000" data-gas="0">‚ö° Electricity Only</button>
            </div>
        </div>

        <!-- Summary Stats -->
        <div class="stats-grid">
            <div class="stat-card best">
                <div class="value" id="bestPrice">-</div>
                <div class="label">Cheapest Deal</div>
            </div>
            <div class="stat-card">
                <div class="value" id="capPrice">-</div>
                <div class="label" id="capLabel">Regional Cap</div>
            </div>
            <div class="stat-card">
                <div class="value" id="savingsAmount">-</div>
                <div class="label">You Could Save</div>
            </div>
            <div class="stat-card">
                <div class="value" id="tariffCount">-</div>
                <div class="label">Tariffs Compared</div>
            </div>
        </div>

        <!-- Chart Section -->
        <div class="chart-section">
            <h2>üìä Top 10 Fixed Deals (Beating The Cap)</h2>
            <div class="chart-container">
                <canvas id="tariffChart"></canvas>
            </div>
        </div>

        <!-- Price Cap Info -->
        <div class="price-cap-section">
            <h2>‚ö†Ô∏è Ofgem Price Cap (Direct Debit, Jan-Mar 2026)</h2>
            <p style="color: #94a3b8; margin-bottom: 15px; font-size: 0.9rem;">The maximum your supplier can charge on a standard variable tariff. All figures include 5% VAT.</p>
            <div class="price-cap-grid">
                <div class="cap-item">
                    <div class="value">¬£1,758*</div>
                    <div class="label">GB Average</div>
                </div>
                <div class="cap-item">
                    <div class="value">27.69p</div>
                    <div class="label">Avg Elec Unit</div>
                </div>
                <div class="cap-item">
                    <div class="value">54.75p</div>
                    <div class="label">Avg Elec Standing</div>
                </div>
                <div class="cap-item">
                    <div class="value">5.93p</div>
                    <div class="label">Avg Gas Unit</div>
                </div>
            </div>
            <p style="color: #64748b; margin-top: 15px; font-size: 0.8rem;">*Based on Ofgem's typical domestic consumption: <strong>2,700 kWh electricity</strong> + <strong>11,500 kWh gas</strong> per year. This is the UK average and varies by region. We calculate your exact regional cap based on your selected area and usage (inc 5% VAT).</p>
        </div>

        <!-- Tariff Cards -->
        <h2 class="section-title">üèÜ Fixed Deals That Beat The Cap in <span id="regionDisplay">London</span></h2>
        <p style="color: #94a3b8; font-size: 0.9rem; margin-bottom: 20px; margin-top: -10px;">Only showing tariffs cheaper than the Ofgem price cap. No point paying SVT rates!</p>
        <div class="tariffs-grid" id="tariffsGrid">
            <div class="loading">Loading tariffs...</div>
        </div>

        <!-- Explainer Section -->
        <div class="explainer-section">
            <h2>üìö Understanding Energy Tariffs</h2>
            <div class="explainer-grid">
                <div class="explainer-item">
                    <h3>üîí Fixed vs Variable</h3>
                    <p><strong>Fixed:</strong> Rate locked for 12-24 months. Protects against price rises but may have exit fees.<br><strong>Variable:</strong> Rate can change anytime, usually following the price cap.</p>
                </div>
                <div class="explainer-item">
                    <h3>üí∑ Standing Charge</h3>
                    <p>Daily fee you pay regardless of usage (typically 30-60p/day per fuel). This covers meter reading, billing, and grid maintenance.</p>
                </div>
                <div class="explainer-item">
                    <h3>‚ö° Unit Rate</h3>
                    <p>Cost per kWh of energy used. This is where most of your bill comes from. Lower is better, but watch the standing charge too!</p>
                </div>
                <div class="explainer-item">
                    <h3>üö™ Exit Fees</h3>
                    <p>Fee to leave a fixed tariff early (typically ¬£25-100 per fuel). No exit fees on variable tariffs or when contract ends.</p>
                </div>
            </div>
        </div>

        <!-- What You're Paying For Section -->
        <div class="breakdown-section" style="background: rgba(255, 255, 255, 0.03); border-radius: 16px; padding: 25px; margin-bottom: 30px;">
            <h2 style="color: #e0e0e0; font-size: 1.2rem; margin-bottom: 20px;">üí∞ What You're Actually Paying For</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                <div style="background: rgba(168, 85, 247, 0.1); border: 1px solid rgba(168, 85, 247, 0.3); border-radius: 12px; padding: 20px;">
                    <h3 style="color: #a855f7; font-size: 1rem; margin-bottom: 12px;">üìä Standing Charge (Nil kWh)</h3>
                    <p style="color: #94a3b8; font-size: 0.85rem; line-height: 1.6;">What you pay even with zero usage. Higher standing charges mean you're funding:</p>
                    <ul style="color: #cbd5e1; font-size: 0.85rem; margin-top: 10px; margin-left: 20px; line-height: 1.8;">
                        <li><strong>Policy costs</strong> - government green levies & schemes</li>
                        <li><strong>Network costs</strong> - maintaining pipes & wires to your home</li>
                        <li><strong>Metering</strong> - smart meter rollout & readings</li>
                        <li><strong>Supplier costs</strong> - billing, customer service, bad debt</li>
                    </ul>
                    <p style="color: #64748b; font-size: 0.8rem; margin-top: 12px;">üí° Standing charges vary by region due to different network costs (DNO areas).</p>
                </div>
                <div style="background: rgba(236, 72, 153, 0.1); border: 1px solid rgba(236, 72, 153, 0.3); border-radius: 12px; padding: 20px;">
                    <h3 style="color: #ec4899; font-size: 1rem; margin-bottom: 12px;">‚ö° Unit Rate (per kWh)</h3>
                    <p style="color: #94a3b8; font-size: 0.85rem; line-height: 1.6;">What you pay per kWh consumed. Higher unit rates mean you're funding more:</p>
                    <ul style="color: #cbd5e1; font-size: 0.85rem; margin-top: 10px; margin-left: 20px; line-height: 1.8;">
                        <li><strong>Wholesale costs</strong> - actual cost of gas & electricity</li>
                        <li><strong>Balancing costs</strong> - keeping the grid stable</li>
                        <li><strong>Losses</strong> - energy lost in transmission</li>
                        <li><strong>Supplier margin</strong> - their profit (typically 1-2%)</li>
                    </ul>
                    <p style="color: #64748b; font-size: 0.8rem; margin-top: 12px;">üí° Low users benefit from low standing charges. High users benefit from low unit rates.</p>
                </div>
            </div>
        </div>

        <!-- REGO Disclaimer -->
        <div class="disclaimer-section" style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(22, 163, 74, 0.05)); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 16px; padding: 25px; margin-bottom: 30px;">
            <h2 style="color: #22c55e; font-size: 1.2rem; margin-bottom: 15px;">üå± What Does "100% Renewable" Actually Mean?</h2>
            <p style="color: #94a3b8; font-size: 0.9rem; line-height: 1.7; margin-bottom: 15px;">
                When a supplier claims "100% renewable electricity", they've purchased <strong style="color: #22c55e;">REGOs</strong> (Renewable Energy Guarantees of Origin) or signed <strong style="color: #22c55e;">PPAs</strong> (Power Purchase Agreements) with UK renewable generators.
            </p>
            <p style="color: #94a3b8; font-size: 0.9rem; line-height: 1.7; margin-bottom: 15px;">
                <strong style="color: #fbbf24;">However:</strong> The electricity physically coming into your home is from the National Grid - a mix of wind, solar, nuclear, gas, and other sources. You can't choose which electrons reach your socket!
            </p>
            <p style="color: #94a3b8; font-size: 0.9rem; line-height: 1.7;">
                Think of it like this: everyone draws from the same pool of water, but green tariffs pay to add more clean water to that pool. Your money supports renewable generation, even if your actual electrons are mixed source.
            </p>
        </div>

        <div class="footer">
            <p>Data scraped daily from supplier websites. Always verify prices before switching.</p>
            <p style="margin-top: 10px;">Built with üíú by <a href="https://switch-pilot.com">SwitchPilot</a></p>
        </div>
    </div>

    <script>
        let tariffData = { tariffs: [], updated: null };
        let chart = null;

        // Supplier info
        const supplierInfo = {
    'octopus': { name: 'Octopus Energy', color: '#ff00ff', green: true, greenNote: '100% renewable' },
    'eon_next': { name: 'E.ON Next', color: '#e4002b', green: true, greenNote: '100% renewable' },
    'british_gas': { name: 'British Gas', color: '#0066cc', green: false, greenNote: 'Standard mix' },
    'ovo': { name: 'OVO Energy', color: '#00dc64', green: true, greenNote: '100% renewable' },
    'scottish_power': { name: 'Scottish Power', color: '#0066b3', green: true, greenNote: '100% renewable' },
    'edf': { name: 'EDF', color: '#ff6600', green: true, greenNote: '100% renewable' },
    'fuse_energy': { name: 'Fuse Energy', color: '#a855f7', green: false, greenNote: 'Standard mix' }
};

        // Ofgem Price Cap rates by region (Jan-Mar 2026, Direct Debit, inc VAT)
        // Source: https://www.ofgem.gov.uk/energy-price-cap
        // Standing charges in p/day, unit rates in p/kWh
        const capRatesByRegion = {
            'North West': { elecStanding: 52.22, elecUnit: 28.45, gasStanding: 35.23, gasUnit: 5.89 },
            'North East': { elecStanding: 60.93, elecUnit: 26.75, gasStanding: 35.21, gasUnit: 5.93 },
            'Yorkshire': { elecStanding: 59.72, elecUnit: 26.69, gasStanding: 35.18, gasUnit: 5.90 },
            'North Scotland': { elecStanding: 62.07, elecUnit: 28.36, gasStanding: 35.28, gasUnit: 5.89 },
            'Southern': { elecStanding: 45.70, elecUnit: 27.83, gasStanding: 34.56, gasUnit: 6.00 },
            'South Scotland': { elecStanding: 57.62, elecUnit: 27.18, gasStanding: 35.30, gasUnit: 5.89 },
            'North Wales & Merseyside': { elecStanding: 71.01, elecUnit: 29.09, gasStanding: 35.49, gasUnit: 5.94 },
            'London': { elecStanding: 47.11, elecUnit: 27.00, gasStanding: 35.63, gasUnit: 6.03 },
            'South East': { elecStanding: 48.66, elecUnit: 28.27, gasStanding: 34.68, gasUnit: 5.83 },
            'Eastern': { elecStanding: 49.33, elecUnit: 27.88, gasStanding: 34.74, gasUnit: 5.87 },
            'East Midlands': { elecStanding: 50.17, elecUnit: 26.89, gasStanding: 34.82, gasUnit: 5.79 },
            'West Midlands': { elecStanding: 54.08, elecUnit: 26.99, gasStanding: 35.12, gasUnit: 5.85 },
            'South West': { elecStanding: 55.11, elecUnit: 28.16, gasStanding: 34.71, gasUnit: 6.15 },
            'South Wales': { elecStanding: 52.75, elecUnit: 28.18, gasStanding: 35.35, gasUnit: 6.11 }
        };

        async function loadData() {
            try {
                const response = await fetch('./all_tariffs.json');
                if (!response.ok) throw new Error('Failed to load');
                tariffData = await response.json();
                
                if (tariffData.updated) {
                    const date = new Date(tariffData.updated);
                    document.getElementById('lastUpdated').textContent = date.toLocaleDateString('en-GB', {
                        day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit'
                    });
                }
                
                render();
            } catch (e) {
                console.error(e);
                document.getElementById('tariffsGrid').innerHTML = '<div class="error">Failed to load tariff data. Please refresh the page.</div>';
            }
        }

        function calculateCost(tariff, elecKwh, gasKwh, fuelType) {
            let total = 0;
            
            if (fuelType === 'dual' || fuelType === 'elec') {
                if (tariff.elec_unit_rate_p && tariff.elec_standing_p) {
                    total += (tariff.elec_standing_p / 100) * 365;
                    total += (tariff.elec_unit_rate_p / 100) * elecKwh;
                }
            }
            
            if (fuelType === 'dual') {
                if (tariff.gas_unit_rate_p && tariff.gas_standing_p) {
                    total += (tariff.gas_standing_p / 100) * 365;
                    total += (tariff.gas_unit_rate_p / 100) * gasKwh;
                }
            }
            
            return total;
        }

        function calculateCapCost(elecKwh, gasKwh, fuelType, region) {
            const rates = capRatesByRegion[region] || capRatesByRegion['London'];
            
            // Calculate from actual unit rates and standing charges (already inc 5% VAT)
            // Standing charge: p/day √ó 365 days / 100 = ¬£/year
            // Unit cost: p/kWh √ó kWh / 100 = ¬£/year
            
            let total = 0;
            
            if (fuelType === 'elec' || fuelType === 'dual') {
                total += (rates.elecStanding * 365) / 100;  // Standing charge
                total += (rates.elecUnit * elecKwh) / 100;   // Unit cost
            }
            
            if (fuelType === 'dual') {
                total += (rates.gasStanding * 365) / 100;   // Standing charge
                total += (rates.gasUnit * gasKwh) / 100;     // Unit cost
            }
            
            return total;
        }

        function isElecOnly(tariff) {
            return !tariff.gas_unit_rate_p || !tariff.gas_standing_p;
        }
        
        function isValidTariff(tariff, fuelType) {
            // Must have tariff name
            if (!tariff.tariff_name || tariff.tariff_name.trim() === '') return false;
            
            // Must not have error
            if (tariff.error) return false;
            
            // For elec-only or dual fuel, must have elec rates
            if (fuelType === 'elec' || fuelType === 'dual') {
                if (!tariff.elec_unit_rate_p || !tariff.elec_standing_p) return false;
                if (tariff.elec_unit_rate_p <= 0 || tariff.elec_standing_p <= 0) return false;
            }
            
            // For dual fuel, must have gas rates
            if (fuelType === 'dual') {
                if (!tariff.gas_unit_rate_p || !tariff.gas_standing_p) return false;
                if (tariff.gas_unit_rate_p <= 0 || tariff.gas_standing_p <= 0) return false;
            }
            
            return true;
        }

        function getExitFee(tariff) {
            // Check if it's dual fuel (has both elec and gas)
            const isDualFuel = tariff.gas_unit_rate_p && tariff.gas_standing_p && 
                              tariff.elec_unit_rate_p && tariff.elec_standing_p;
            
            // No exit fee
            if (!tariff.exit_fee_gbp || tariff.exit_fee_gbp === '¬£0' || tariff.exit_fee_gbp === 0) {
                return '¬£0';
            }
            
            // If it's a number (like 50), this is per fuel
            if (typeof tariff.exit_fee_gbp === 'number') {
                if (isDualFuel) {
                    // Dual fuel = 2√ó the fee (elec + gas)
                    return `¬£${(tariff.exit_fee_gbp * 2).toFixed(2)} total (¬£${tariff.exit_fee_gbp.toFixed(2)} per fuel)`;
                } else {
                    return `¬£${tariff.exit_fee_gbp.toFixed(2)}`;
                }
            }
            
            // If it's a string
            let feeStr = tariff.exit_fee_gbp.replace(/\\u00a3/g, '¬£');
            
            // If it already says "per fuel", calculate total for dual fuel
            if (feeStr.toLowerCase().includes('per fuel') && isDualFuel) {
                const match = feeStr.match(/¬£?(\d+(?:\.\d+)?)/);
                if (match) {
                    const perFuel = parseFloat(match[1]);
                    return `¬£${(perFuel * 2).toFixed(2)} total (¬£${perFuel.toFixed(2)} per fuel)`;
                }
            }
            
            // Plain string like "¬£50.00" - extract number and multiply for dual fuel
            if (isDualFuel) {
                const match = feeStr.match(/¬£?(\d+(?:\.\d+)?)/);
                if (match) {
                    const perFuel = parseFloat(match[1]);
                    return `¬£${(perFuel * 2).toFixed(2)} total (¬£${perFuel.toFixed(2)} per fuel)`;
                }
            }
            
            // Return as-is (single fuel or couldn't parse)
            return feeStr;
        }

        function getPros(tariff, savings, supplier) {
            const pros = [];
            if (savings > 100) pros.push(`Save ¬£${Math.round(savings)}/year vs cap`);
            if (supplier?.green) pros.push(supplier.greenNote);
            if (getExitFee(tariff).includes('¬£0')) pros.push('No exit fees');
            if (tariff.tariff_name?.toLowerCase().includes('fixed')) pros.push('Price protection');
            // Removed fake rating - we don't have real review data
            return pros.slice(0, 3);
        }

        function getCons(tariff, savings, supplier) {
            const cons = [];
            const exitFee = getExitFee(tariff);
            if (!exitFee.includes('¬£0')) cons.push(`Exit fee: ${exitFee}`);
            if (isElecOnly(tariff)) cons.push('Electricity only');
            if (tariff.tariff_name?.toLowerCase().includes('variable')) cons.push('Price may change');
            // Removed fake "Average reviews" - we don't have real review data
            if (tariff.tariff_name?.toLowerCase().includes('go') || tariff.tariff_name?.toLowerCase().includes('ev')) cons.push('Requires EV/equipment');
            return cons.slice(0, 3);
        }

        function render() {
            const region = document.getElementById('region').value;
            const elecUsage = parseInt(document.getElementById('elecUsage').value) || 2700;
            const gasUsage = parseInt(document.getElementById('gasUsage').value) || 11500;
            const fuelType = document.getElementById('fuelType').value;

            document.getElementById('regionDisplay').textContent = region;

            // Calculate cap cost
            const capCost = calculateCapCost(elecUsage, gasUsage, fuelType, region);

            // Filter and calculate
            let filtered = tariffData.tariffs
                .filter(t => t.region === region)
                .filter(t => isValidTariff(t, fuelType))  // Validate complete data first
                .filter(t => {
                    // Remove SVT and standard tariffs - we only want fixed deals that beat the cap
                    const name = (t.tariff_name || '').toLowerCase().trim();
                    if (name.includes('variable') || name.includes('svt') || name.includes('standard')) return false;
                    return true;
                })
                .map(t => ({
                    ...t,
                    annualCost: calculateCost(t, elecUsage, gasUsage, fuelType),
                    isElecOnly: isElecOnly(t),
                    savings: capCost - calculateCost(t, elecUsage, gasUsage, fuelType)
                }))
                .filter(t => {
                    if (fuelType === 'dual' && t.isElecOnly) return false;
                    if (t.annualCost <= 0) return false;
                    // Only show tariffs that actually beat the cap
                    if (t.savings < 0) return false;
                    return true;
                })
                .sort((a, b) => a.annualCost - b.annualCost);

            // Update stats
            document.getElementById('capPrice').textContent = `¬£${Math.round(capCost)}`;
            document.getElementById('capLabel').textContent = `Cap (${region.length > 10 ? region.substring(0, 8) + '...' : region})`;
            document.getElementById('tariffCount').textContent = filtered.length;
            
            if (filtered.length > 0) {
                document.getElementById('bestPrice').textContent = `¬£${Math.round(filtered[0].annualCost)}`;
                document.getElementById('savingsAmount').textContent = `¬£${Math.round(filtered[0].savings)}/yr`;
            } else {
                document.getElementById('bestPrice').textContent = '-';
                document.getElementById('savingsAmount').textContent = '-';
            }

            // Update chart
            updateChart(filtered.slice(0, 10), capCost);

            // Render cards (top 5)
            const top5 = filtered.slice(0, 5);
            const grid = document.getElementById('tariffsGrid');
            
            if (top5.length === 0) {
                grid.innerHTML = '<div class="loading">No fixed deals currently beat the price cap for this region/fuel type. Check back soon!</div>';
                return;
            }

            grid.innerHTML = top5.map((tariff, index) => {
                const supplier = supplierInfo[tariff.supplier] || { name: tariff.supplier, color: '#a855f7', green: false };
                const pros = getPros(tariff, tariff.savings, supplier);
                const cons = getCons(tariff, tariff.savings, supplier);
                
                // Fix tariff name if it's the same as supplier (data bug)
                let displayTariffName = tariff.tariff_name || supplier.name + ' Standard';
                if (displayTariffName === tariff.supplier || displayTariffName === supplier.name) {
                    displayTariffName = 'Standard Tariff';
                }
                
                return `
                    <div class="tariff-card ${index === 0 ? 'best' : ''}">
                        ${index === 0 ? '<div class="best-badge">üèÜ Best Deal</div>' : ''}
                        <div class="rank-badge">#${index + 1}</div>
                        
                        <div class="supplier-header">
                            <div>
                                <div class="supplier-name" style="color: ${supplier.color}">${supplier.name}</div>
                                <div class="tariff-name">${displayTariffName}</div>
                            </div>
                            <div class="annual-cost">
                                <div class="cost-amount">¬£${Math.round(tariff.annualCost)}</div>
                                <div class="cost-label">per year</div>
                                ${tariff.savings > 0 
                                    ? `<div class="savings-tag positive">Save ¬£${Math.round(tariff.savings)}</div>`
                                    : `<div class="savings-tag negative">¬£${Math.abs(Math.round(tariff.savings))} more</div>`
                                }
                            </div>
                        </div>

                        <div class="card-badges">
                            ${supplier.green ? '<span class="badge green">üå± Green</span>' : ''}
                            ${tariff.tariff_name?.toLowerCase().includes('fixed') ? '<span class="badge blue">üîí Fixed</span>' : '<span class="badge yellow">üìà Variable</span>'}
                            ${getExitFee(tariff).includes('¬£0') ? '<span class="badge purple">‚úì No Exit Fee</span>' : ''}
                        </div>

                        <div class="rates-grid">
                            <div class="rate-item">
                                <div class="rate-label">Elec Unit</div>
                                <div class="rate-value">${tariff.elec_unit_rate_p?.toFixed(2) || '-'}p/kWh</div>
                            </div>
                            <div class="rate-item">
                                <div class="rate-label">Elec Standing</div>
                                <div class="rate-value">${tariff.elec_standing_p?.toFixed(2) || '-'}p/day</div>
                            </div>
                            ${!tariff.isElecOnly ? `
                            <div class="rate-item">
                                <div class="rate-label">Gas Unit</div>
                                <div class="rate-value">${tariff.gas_unit_rate_p?.toFixed(2) || '-'}p/kWh</div>
                            </div>
                            <div class="rate-item">
                                <div class="rate-label">Gas Standing</div>
                                <div class="rate-value">${tariff.gas_standing_p?.toFixed(2) || '-'}p/day</div>
                            </div>
                            ` : ''}
                        </div>

                        ${tariff.isElecOnly ? '<div class="elec-only-warning">‚ö° Electricity only - you\'ll need separate gas</div>' : ''}

                        <div class="pros-cons">
                            <div class="pros">
                                <h4>‚úì Pros</h4>
                                <ul>${pros.map(p => `<li>${p}</li>`).join('')}</ul>
                            </div>
                            <div class="cons">
                                <h4>‚úó Cons</h4>
                                <ul>${cons.length > 0 ? cons.map(c => `<li>${c}</li>`).join('') : '<li>None significant</li>'}</ul>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateChart(tariffs, capCost) {
            const ctx = document.getElementById('tariffChart').getContext('2d');
            
            const labels = tariffs.map(t => {
                const supplier = supplierInfo[t.supplier]?.name || t.supplier;
                const tariffName = t.tariff_name || 'Standard';
                const full = supplier + ' - ' + tariffName;
                return full.length > 28 ? full.substring(0, 25) + '...' : full;
            });
            
            const data = tariffs.map(t => Math.round(t.annualCost));
            const colors = tariffs.map((t, i) => i === 0 ? '#22c55e' : '#a855f7');

            if (chart) chart.destroy();

            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Annual Cost (¬£)',
                        data: data,
                        backgroundColor: colors,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#94a3b8', callback: v => '¬£' + v }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { color: '#e0e0e0' }
                        }
                    }
                }
            });
        }

        // Event listeners
        document.querySelectorAll('select, input').forEach(el => {
            el.addEventListener('change', render);
            el.addEventListener('input', render);
        });

        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.getElementById('elecUsage').value = this.dataset.elec;
                document.getElementById('gasUsage').value = this.dataset.gas;
                if (this.dataset.gas === '0') {
                    document.getElementById('fuelType').value = 'elec';
                } else {
                    document.getElementById('fuelType').value = 'dual';
                }
                render();
            });
        });

        // Load data on page load
        loadData();
    </script>
</body>
</html>
