name: E.ON + EDF Scrapers

on:
  schedule:
    - cron: '0 2 * * 0'  # 2am UTC, Sundays
  workflow_dispatch:

jobs:
  scrape-eon:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Chrome for undetected-chromedriver
      run: |
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable

    - name: Install Python dependencies
      run: |
        pip install undetected-chromedriver selenium

    - name: Create screenshots directory
      run: mkdir -p screenshots

    - name: Run E.ON scraper
      run: |
        python eon_next_scraper_v5.py --headless --wait 45 --retries 2
      continue-on-error: true

    - name: Upload E.ON results
      uses: actions/upload-artifact@v4
      with:
        name: eon-results
        path: |
          eon_tariffs_*.json
          eon_tariffs_*.csv
        retention-days: 7

  scrape-edf:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Playwright
      run: |
        pip install playwright
        playwright install chromium
        playwright install-deps

    - name: Create screenshots directory
      run: mkdir -p screenshots

    - name: Run EDF scraper
      run: |
        python edf_scraper_v5_fixed.py --headless --wait 30
      continue-on-error: true

    - name: Upload EDF results
      uses: actions/upload-artifact@v4
      with:
        name: edf-results
        path: |
          edf_tariffs_*.json
          edf_tariffs_*.csv
        retention-days: 7

  combine-results:
    needs: [scrape-eon, scrape-edf]
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download E.ON results
      uses: actions/download-artifact@v4
      with:
        name: eon-results
        path: ./results
      continue-on-error: true

    - name: Download EDF results
      uses: actions/download-artifact@v4
      with:
        name: edf-results
        path: ./results
      continue-on-error: true

    - name: List results
      run: |
        echo "=== Downloaded results ==="
        ls -la ./results/ || echo "No results found"

    - name: Commit and push results
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        cp results/*.json . 2>/dev/null || true
        cp results/*.csv . 2>/dev/null || true
        git add eon_tariffs_*.json edf_tariffs_*.json eon_tariffs_*.csv edf_tariffs_*.csv 2>/dev/null || true
        git diff --staged --quiet || git commit -m "E.ON + EDF update $(date +'%Y-%m-%d %H:%M')"
        git push || echo "Nothing to push"
